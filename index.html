<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Municipal Data Management System | Ravi Patel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Playfair+Display:ital,wght@0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#12191f;--paper:#f7f3ec;--cream:#ede8dc;--gold:#b8853a;
  --gold-lt:#e8c97a;--sage:#2d5a3d;--rust:#7d2e1a;--slate:#1e3448;
  --muted:#7a7060;--rule:#cfc5b0;--white:#fff;
  --green:#1b5e38;--red:#7d1a1a;--amber:#7a5500;--blue:#0d3159;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Mono',monospace;background:var(--paper);color:var(--ink);min-height:100vh;}

/* SPLASH */
#splash{position:fixed;inset:0;background:var(--ink);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .7s ease;}
#splash.out{opacity:0;pointer-events:none;}
.sp-seal{width:110px;height:110px;border:2.5px solid var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:28px;animation:pop .7s cubic-bezier(.175,.885,.32,1.275) .2s both;}
@keyframes pop{from{transform:scale(0) rotate(-15deg);opacity:0;}to{transform:scale(1) rotate(0);opacity:1;}}
.sp-title{font-family:'Playfair Display',serif;font-size:2.6rem;color:var(--paper);text-align:center;animation:up .5s ease .7s both;letter-spacing:-.02em;}
.sp-sub{font-size:.68rem;color:var(--gold);letter-spacing:.18em;text-transform:uppercase;margin-top:8px;animation:up .5s ease .9s both;text-align:center;}
.sp-desc{font-size:.62rem;color:var(--muted);margin-top:20px;text-align:center;max-width:380px;line-height:1.6;animation:up .5s ease 1.1s both;}
.sp-btn{margin-top:36px;padding:13px 42px;background:transparent;border:1.5px solid var(--gold);color:var(--gold);font-family:'DM Mono',monospace;font-size:.72rem;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:all .2s;animation:up .5s ease 1.3s both;}
.sp-btn:hover{background:var(--gold);color:var(--ink);}
@keyframes up{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

/* APP */
#app{display:none;flex-direction:column;min-height:100vh;}
#app.show{display:flex;}

/* TOPBAR */
.topbar{background:var(--ink);height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 28px;border-bottom:2px solid var(--gold);position:sticky;top:0;z-index:200;}
.tb-brand{font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--paper);}
.tb-brand em{color:var(--gold);font-style:normal;}
.tb-meta{font-size:.6rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;}
.tb-user{display:flex;align-items:center;gap:10px;font-size:.65rem;color:var(--cream);}
.tb-badge{background:var(--gold);color:var(--ink);padding:2px 9px;font-size:.58rem;font-weight:500;letter-spacing:.06em;}

/* NAV TABS */
.nav{background:var(--cream);border-bottom:1px solid var(--rule);padding:0 28px;display:flex;overflow-x:auto;}
.nav-tab{padding:13px 20px;font-size:.66rem;letter-spacing:.08em;text-transform:uppercase;background:none;border:none;border-bottom:3px solid transparent;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap;margin-bottom:-1px;}
.nav-tab:hover{color:var(--ink);}
.nav-tab.on{color:var(--ink);border-bottom-color:var(--gold);background:var(--paper);}

/* SECTIONS */
.content{padding:28px;flex:1;}
.sec{display:none;animation:secIn .3s ease;}
.sec.on{display:block;}
@keyframes secIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

.ph{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:600;letter-spacing:-.02em;margin-bottom:4px;}
.ps{font-size:.62rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;padding-bottom:16px;border-bottom:1px solid var(--rule);margin-bottom:24px;}

/* STAT CARDS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:28px;}
.sc{background:var(--white);border:1px solid var(--rule);border-top:3px solid var(--gold);padding:18px;transition:transform .15s,box-shadow .15s;cursor:pointer;}
.sc:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.10);}
.sc:active{transform:translateY(-1px);}
.sc .sc-arrow{font-size:.6rem;color:var(--gold);margin-top:6px;opacity:0;transition:opacity .15s;}
.sc:hover .sc-arrow{opacity:1;}
.sc.g{border-top-color:var(--sage);}
.sc.r{border-top-color:var(--rust);}
.sc.b{border-top-color:var(--slate);}
.sc-n{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;line-height:1;margin-bottom:4px;}
.sc-l{font-size:.6rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;}

/* TOOLBAR */
.tb2{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;align-items:center;}
input[type=text],.fsel{padding:8px 12px;border:1px solid var(--rule);background:var(--white);font-family:'DM Mono',monospace;font-size:.74rem;color:var(--ink);outline:none;}
input[type=text]{flex:1;min-width:200px;}
input[type=text]:focus,.fsel:focus{border-color:var(--gold);}
.btn{padding:8px 16px;font-family:'DM Mono',monospace;font-size:.68rem;letter-spacing:.06em;text-transform:uppercase;border:none;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn-p{background:var(--ink);color:var(--paper);}
.btn-p:hover{background:var(--slate);}
.btn-g{background:var(--gold);color:var(--ink);}
.btn-g:hover{background:var(--gold-lt);}
.btn-o{background:transparent;color:var(--ink);border:1px solid var(--rule);}
.btn-o:hover{border-color:var(--ink);}
.btn-d{background:var(--rust);color:var(--white);}
.btn-d:hover{background:#5c1a0a;}
.btn-s{background:var(--sage);color:var(--white);}

/* TABLE */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;background:var(--white);}
thead tr{background:var(--ink);}
thead th{padding:10px 13px;text-align:left;font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;font-weight:500;color:var(--paper);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--cream);transition:background .1s;}
tbody tr:hover{background:var(--cream);}
tbody td{padding:10px 13px;font-size:.72rem;vertical-align:middle;}
.act-link{background:none;border:none;color:var(--gold);font-family:'DM Mono',monospace;font-size:.68rem;cursor:pointer;text-decoration:underline;padding:0 4px;}
.act-link:hover{color:var(--rust);}

/* BADGES */
.bdg{display:inline-block;padding:2px 7px;font-size:.56rem;letter-spacing:.07em;text-transform:uppercase;font-weight:500;}
.bdg-act{background:#d4edda;color:#155724;}
.bdg-rev{background:#fff3cd;color:#856404;}
.bdg-dis{background:#f8d7da;color:#721c24;}
.bdg-arc{background:#d1ecf1;color:#0c5460;}
.bdg-pub{background:#e8f5e9;color:#1b5e20;}
.bdg-con{background:#ffe0b2;color:#5d3a00;}
.bdg-res{background:#fce4ec;color:#880e4f;}
.bdg-hi{background:#f3e5f5;color:#4a148c;}

/* MODAL */
.ov{position:fixed;inset:0;background:rgba(18,25,31,.65);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;}
.ov.open{display:flex;}
.modal{background:var(--paper);border-top:4px solid var(--gold);width:100%;max-width:640px;max-height:92vh;overflow-y:auto;animation:mIn .25s cubic-bezier(.175,.885,.32,1.275);}
@keyframes mIn{from{transform:scale(.94) translateY(-18px);opacity:0;}to{transform:scale(1) translateY(0);opacity:1;}}
.mh{padding:20px 24px 16px;border-bottom:1px solid var(--rule);display:flex;align-items:center;justify-content:space-between;}
.mt{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:600;}
.mc{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--muted);line-height:1;padding:2px 6px;}
.mc:hover{color:var(--ink);}
.mb{padding:24px;}
.mf{padding:16px 24px;border-top:1px solid var(--rule);display:flex;gap:10px;justify-content:flex-end;}
.fg{margin-bottom:16px;}
label.fl{display:block;font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.fi,.fs,.fta{width:100%;padding:8px 11px;border:1px solid var(--rule);background:var(--white);font-family:'DM Mono',monospace;font-size:.74rem;color:var(--ink);outline:none;}
.fi:focus,.fs:focus,.fta:focus{border-color:var(--gold);}
.fta{min-height:72px;resize:vertical;}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

/* RETENTION RULES */
.ret-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;}
.ret-card{background:var(--white);border:1px solid var(--rule);padding:20px;border-left:4px solid var(--gold);}
.ret-card.g{border-left-color:var(--sage);}
.ret-card.r{border-left-color:var(--rust);}
.ret-card.b{border-left-color:var(--slate);}
.ret-cat{font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.ret-name{font-family:'Playfair Display',serif;font-size:1rem;font-weight:600;margin-bottom:8px;}
.ret-row{display:flex;justify-content:space-between;font-size:.68rem;padding:3px 0;border-bottom:1px solid var(--cream);}
.ret-key{color:var(--muted);}
.ret-val{font-weight:500;}

/* AUDIT LOG */
.log-entry{display:flex;gap:14px;padding:10px 0;border-bottom:1px solid var(--cream);align-items:flex-start;}
.log-ts{font-size:.6rem;color:var(--muted);white-space:nowrap;padding-top:2px;min-width:130px;}
.log-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0;}
.li-add{background:#d4edda;color:#155724;}
.li-edit{background:#fff3cd;color:#856404;}
.li-del{background:#f8d7da;color:#721c24;}
.li-view{background:#d1ecf1;color:#0c5460;}
.li-dis{background:#fce4ec;color:#880e4f;}
.log-text{font-size:.72rem;line-height:1.5;}
.log-user{font-weight:500;color:var(--ink);}

/* POLICY BUILDER */
.policy-section{background:var(--white);border:1px solid var(--rule);padding:22px;margin-bottom:18px;}
.pol-h{font-family:'Playfair Display',serif;font-size:1rem;font-weight:600;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--cream);}
.pol-clause{padding:10px 0;border-bottom:1px solid var(--cream);display:flex;gap:12px;align-items:flex-start;}
.pol-num{font-size:.65rem;color:var(--gold);font-weight:500;min-width:24px;padding-top:2px;}
.pol-text{font-size:.74rem;line-height:1.6;}
.pol-tag{display:inline-block;background:var(--tag,#e8dfc8);color:var(--ink);font-size:.56rem;padding:1px 6px;letter-spacing:.07em;text-transform:uppercase;margin-left:6px;vertical-align:middle;}

/* CLASSIFICATION TREE */
.tree{font-size:.74rem;}
.tree-node{padding:2px 0;}
.tree-parent{font-weight:500;color:var(--ink);cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:2px;transition:background .1s;}
.tree-parent:hover{background:var(--cream);}
.tree-children{margin-left:20px;border-left:1px solid var(--rule);padding-left:12px;overflow:hidden;max-height:0;transition:max-height .3s ease;}
.tree-children.open{max-height:600px;}
.tree-child{padding:5px 6px;display:flex;align-items:center;justify-content:space-between;border-radius:2px;transition:background .1s;}
.tree-child:hover{background:var(--cream);}

/* INFO BOX */
.info-box{background:var(--slate);color:var(--paper);padding:16px 20px;border-left:4px solid var(--gold);font-size:.72rem;line-height:1.7;margin-bottom:20px;}
.info-box strong{color:var(--gold-lt);}

/* PROGRESS BAR */
.prog-wrap{background:var(--cream);height:6px;margin-top:6px;}
.prog-bar{height:100%;background:var(--gold);transition:width .3s ease;}
.prog-bar.g{background:var(--sage);}
.prog-bar.r{background:var(--rust);}

/* NOTIFICATION */
#notif{position:fixed;top:70px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.notif-item{padding:12px 18px;font-size:.72rem;display:flex;align-items:center;gap:10px;animation:nIn .3s ease;pointer-events:all;max-width:320px;}
@keyframes nIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
.ni-ok{background:var(--sage);color:var(--white);}
.ni-err{background:var(--rust);color:var(--white);}
.ni-info{background:var(--slate);color:var(--paper);}

/* WIZARD */
.wizard-steps{display:flex;gap:0;margin-bottom:28px;}
.wstep{flex:1;padding:12px;text-align:center;background:var(--cream);border:1px solid var(--rule);font-size:.62rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);position:relative;}
.wstep.done{background:var(--sage);color:var(--white);border-color:var(--sage);}
.wstep.active{background:var(--ink);color:var(--gold);border-color:var(--ink);}
.wizard-pane{display:none;}
.wizard-pane.on{display:block;}

/* ABOUT */
.about-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}

/* ═══════════════════════════════════════════════════════
   RESPONSIVE — LAPTOP / TABLET / MOBILE
═══════════════════════════════════════════════════════ */

/* Fluid content padding */
.content{padding:clamp(12px,3vw,28px);}

/* Splash responsive */
@media(max-width:480px){
  .sp-title{font-size:1.6rem;}
  .sp-desc{max-width:90vw;padding:0 16px;}
  .sp-btn{padding:11px 28px;}
}

/* Topbar responsive */
@media(max-width:768px){
  .topbar{padding:0 14px;height:48px;}
  .tb-meta{display:none;}
  .tb-brand{font-size:.88rem;}
}
@media(max-width:480px){
  .tb-user span:first-child{display:none;}
  .tb-brand em{display:none;}
  .tb-brand::after{content:'MDMS';color:var(--gold);}
}

/* Nav tabs — scrollable on mobile */
.nav{padding:0 14px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.nav::-webkit-scrollbar{display:none;}
@media(max-width:480px){
  .nav-tab{padding:11px 13px;font-size:.6rem;letter-spacing:.04em;}
}

/* Section headings */
@media(max-width:480px){
  .ph{font-size:1.2rem;}
  .ps{font-size:.58rem;}
}

/* Stat cards */
@media(max-width:480px){
  .stats{grid-template-columns:repeat(2,1fr);gap:10px;}
  .sc{padding:12px;}
  .sc-n{font-size:1.5rem;}
}

/* Dashboard 2-col charts → 1-col */
.dash-charts{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;}
@media(max-width:700px){
  .dash-charts{grid-template-columns:1fr;}
}

/* Toolbar wrap */
@media(max-width:600px){
  .tb2{gap:7px;}
  .tb2 input[type=text]{min-width:100%;flex:unset;width:100%;}
  .fsel{width:100%;}
  .btn{font-size:.62rem;padding:7px 12px;}
}

/* Table — horizontal scroll + compact */
@media(max-width:900px){
  thead th,tbody td{padding:8px 9px;}
}
@media(max-width:600px){
  .tbl-wrap{font-size:.66rem;}
  thead th,tbody td{padding:7px 7px;font-size:.6rem;}
}

/* Bulk actions bar */
.bulk-bar{display:flex;justify-content:space-between;align-items:center;margin-top:10px;flex-wrap:wrap;gap:8px;}
@media(max-width:600px){
  .bulk-bar{flex-direction:column;align-items:flex-start;}
  .bulk-bar > div{width:100%;display:flex;flex-wrap:wrap;gap:6px;}
  .bulk-bar .btn{flex:1;min-width:calc(50% - 4px);text-align:center;}
}

/* Classification two-column */
.classify-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){
  .classify-grid{grid-template-columns:1fr;}
}

/* Policy wizard two-column */
.policy-grid{display:grid;grid-template-columns:1fr 280px;gap:20px;}
@media(max-width:900px){
  .policy-grid{grid-template-columns:1fr;}
}
@media(max-width:480px){
  .wizard-steps{flex-wrap:wrap;gap:4px;}
  .wstep{flex:unset;width:calc(50% - 2px);font-size:.55rem;padding:9px 6px;}
}

/* Retention grid */
@media(max-width:480px){
  .ret-grid{grid-template-columns:1fr;}
}

/* Modal responsive */
@media(max-width:600px){
  .ov{padding:8px;}
  .modal{max-height:96vh;}
  .mb{padding:16px;}
  .mh{padding:14px 16px 12px;}
  .mf{padding:12px 16px;flex-wrap:wrap;}
  .mf .btn{flex:1;text-align:center;}
  .fr2{grid-template-columns:1fr;}
}

/* Audit log */
@media(max-width:480px){
  .log-ts{min-width:90px;font-size:.55rem;}
  .log-text{font-size:.66rem;}
}

/* About grid */
@media(max-width:700px){
  .about-grid{grid-template-columns:1fr;}
}

/* General fr2 single col on small */
@media(max-width:500px){
  .fr2{grid-template-columns:1fr;}
}

/* Retention cards action buttons */
@media(max-width:400px){
  .ret-card .btn{font-size:.58rem;padding:5px 6px;}
}

/* Touch-friendly tap targets */
@media(hover:none){
  .btn,.act-link,.nav-tab,.tree-parent,.tree-child{min-height:38px;display:inline-flex;align-items:center;justify-content:center;}
  .nav-tab{min-height:44px;}
  .act-link{min-height:32px;}
}

.about-card{background:var(--white);border:1px solid var(--rule);padding:20px;}
.about-card h3{font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--cream);}
.about-card ul{padding-left:0;list-style:none;}
.about-card li{font-size:.72rem;padding:4px 0;border-bottom:1px solid var(--cream);display:flex;gap:8px;align-items:flex-start;}
.about-card li::before{content:"▸";color:var(--gold);flex-shrink:0;}

/* POLICY EDITABLE CLAUSES */
.pol-text[contenteditable]{outline:none;border-radius:2px;transition:background .15s;}
.pol-text[contenteditable]:hover{background:rgba(184,133,58,.06);}
.pol-text[contenteditable]:focus{background:rgba(184,133,58,.1);box-shadow:inset 0 0 0 1px var(--gold);padding:4px 6px;}

.tag{--tag:#e8dfc8;}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-seal">
    <svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="10" y="8" width="32" height="40" rx="2" stroke="#b8853a" stroke-width="1.5"/>
      <rect x="14" y="14" width="20" height="2" rx="1" fill="#b8853a"/>
      <rect x="14" y="20" width="20" height="2" rx="1" fill="#b8853a"/>
      <rect x="14" y="26" width="14" height="2" rx="1" fill="#b8853a"/>
      <rect x="14" y="32" width="16" height="2" rx="1" fill="#b8853a"/>
      <circle cx="42" cy="42" r="10" fill="#b8853a"/>
      <path d="M37 42l3 3 5-6" stroke="#12191f" stroke-width="1.8" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="sp-title">Municipal Data Management</div>
  <div class="sp-sub">Electronic Document & Records Management System</div>
  <div class="sp-desc">A fully functional frontend portfolio project demonstrating municipal data management, retention scheduling, classification taxonomy, policy development, and audit trail management.</div>
  <button class="sp-btn" onclick="launchApp()">Launch System →</button>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="tb-brand"><em>MDS</em> Municipal Data Management</div>
    <div class="tb-meta">Municipal Services · Records &amp; Data Management</div>
    <div class="tb-user">
      <span>Ravi Patel</span>
      <span class="tb-badge">Records Tech</span>
    </div>
  </div>

  <div class="nav" id="mainNav">
    <button class="nav-tab on" onclick="showTab('dashboard',this)">Dashboard</button>
    <button class="nav-tab" onclick="showTab('records',this)">Records Registry</button>
    <button class="nav-tab" onclick="showTab('classify',this)">Classification</button>
    <button class="nav-tab" onclick="showTab('retention',this)">Retention Schedule</button>
    <button class="nav-tab" onclick="showTab('policy',this)">Policy Builder</button>
    <button class="nav-tab" onclick="showTab('audit',this)">Audit Trail</button>
    <button class="nav-tab" onclick="showTab('about',this)">About Project</button>
  </div>

  <div class="content">
    <div id="notif"></div>

    <!-- ═══════════════════════════════════════════ DASHBOARD -->
    <div class="sec on" id="sec-dashboard">
      <div class="ph">Records Management Dashboard</div>
      <div class="ps">Municipal Services · Records &amp; Data Management Department · <span id="dash-date"></span></div>

      <div class="info-box">
        <strong>System Note:</strong> This system was built as a hands-on portfolio project to demonstrate practical EDRMS competency. All records, retention rules, and classifications below reflect real municipal records categories based on Alberta's <em>Municipal Government Act</em> and the <em>Records Management Regulation (AR 225/2001)</em>.
      </div>

      <div class="stats" id="dashStats"></div>

      <div class="dash-charts">
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Records by Status</div>
          <div id="statusChart"></div>
        </div>
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Disposition Due This Quarter</div>
          <div id="dispChart"></div>
        </div>
      </div>

      <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Recent Activity</div>
      <div id="recentActivity"></div>
    </div>

    <!-- ═══════════════════════════════════════════ RECORDS -->
    <div class="sec" id="sec-records">
      <div class="ph">Records Registry</div>
      <div class="ps">Create · Classify · Retrieve · Manage disposition of all corporate records</div>

      <div class="tb2">
        <input type="text" id="recSearch" placeholder="Search records by title, ID, or classification…" oninput="window._vitalFilter=false;renderRecords()">
        <select class="fsel" id="recStatusF" onchange="window._vitalFilter=false;renderRecords()">
          <option value="">All Statuses</option>
          <option value="Active">Active</option>
          <option value="Under Review">Under Review</option>
          <option value="Pending Disposition">Pending Disposition</option>
          <option value="Archived">Archived</option>
        </select>
        <select class="fsel" id="recClassF" onchange="window._vitalFilter=false;renderRecords()">
          <option value="">All Classifications</option>
          <option value="Administrative">Administrative</option>
          <option value="Financial">Financial</option>
          <option value="Legal">Legal</option>
          <option value="Infrastructure">Infrastructure</option>
          <option value="Personnel">Personnel</option>
          <option value="Planning">Planning</option>
        </select>
        <button class="btn btn-g" onclick="openModal('addRecModal')">+ Add Record</button>
      </div>

      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th style="width:30px"><input type="checkbox" id="chkAll" onchange="toggleAll(this)" style="cursor:pointer"></th>
            <th>Record ID</th><th>Title</th><th>Classification</th>
            <th>Security</th><th>Status</th><th>Created</th><th>Retention Ends</th><th>Actions</th>
          </tr></thead>
          <tbody id="recTbody"></tbody>
        </table>
      </div>
      <div class="bulk-bar">
        <div id="recCount" style="font-size:.65rem;color:var(--muted);"></div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="font-size:.62rem;color:var(--muted)">Bulk:</span>
          <button class="btn btn-o" style="font-size:.62rem;padding:5px 10px" onclick="selectAll()">Select All</button>
          <button class="btn btn-o" style="font-size:.62rem;padding:5px 10px" onclick="clearSel()">Clear</button>
          <button class="btn btn-d" style="font-size:.62rem;padding:5px 10px" onclick="bulkDelete()">Delete Selected</button>
          <button class="btn" style="font-size:.62rem;padding:5px 10px;background:var(--slate);color:var(--paper)" onclick="exportRecords()">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════ CLASSIFICATION -->
    <div class="sec" id="sec-classify">
      <div class="ph">Classification Scheme</div>
      <div class="ps">Hierarchical taxonomy aligned with Municipal Government Act functional categories</div>

      <div class="info-box">
        <strong>Alberta Municipal Classification Standard:</strong> This scheme follows the <em>ARMA International</em> functional classification framework adapted for Alberta municipalities. Top-level classes reflect primary municipal functions; subclasses reflect record series within each function.
      </div>

      <div class="classify-grid">
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Functional Classification Tree</div>
          <div style="background:var(--white);border:1px solid var(--rule);padding:16px;">
            <div class="tree" id="classTree"></div>
          </div>
        </div>
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Selected Class Detail</div>
          <div id="classDetail" style="background:var(--white);border:1px solid var(--rule);padding:16px;min-height:300px;">
            <div style="color:var(--muted);font-size:.72rem;padding-top:40px;text-align:center;">← Select a classification from the tree</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════ RETENTION -->
    <div class="sec" id="sec-retention">
      <div class="ph">Retention & Disposition Schedule</div>
      <div class="ps">Managed in accordance with Alberta Records Management Regulation AR 225/2001</div>

      <div class="info-box">
        <strong>Legislative Basis:</strong> Retention periods set per <em>Municipal Government Act RSA 2000</em>, <em>Local Authorities Election Act</em>, <em>Freedom of Information and Protection of Privacy Act (FOIP)</em>, and <em>Municipal Government Act</em> s.207. Disposition actions: Destroy (D), Transfer to Archives (A), or Permanent Retention (P).
      </div>

      <div class="tb2">
        <button class="btn btn-g" onclick="openModal('addRetModal')">+ Add Retention Rule</button>
        <button class="btn btn-o" onclick="exportRetention()">Export Schedule</button>
      </div>

      <div class="ret-grid" id="retGrid"></div>
    </div>

    <!-- ═══════════════════════════════════════════ POLICY -->
    <div class="sec" id="sec-policy">
      <div class="ph">Policy Builder</div>
      <div class="ps">Draft, review and publish records management policies and procedures</div>

      <!-- Policy list view -->
      <div id="pol-list-view">
        <div class="tb2">
          <button class="btn btn-g" onclick="openNewPolicyModal()">+ New Policy</button>
          <select class="fsel" id="polStatusF" onchange="renderPolIndex()">
            <option value="">All Statuses</option>
            <option value="Draft">Draft</option>
            <option value="Under Review">Under Review</option>
            <option value="Approved">Approved</option>
          </select>
          <button class="btn btn-o" onclick="exportPolicies()">Export List</button>
        </div>

        <div id="pol-table-wrap" style="overflow-x:auto;">
          <table>
            <thead><tr>
              <th>Policy ID</th><th>Title</th><th>Category</th><th>Owner</th><th>Status</th><th>Created</th><th>Review Date</th><th>Actions</th>
            </tr></thead>
            <tbody id="polTbody"></tbody>
          </table>
        </div>
        <div id="polCount" style="font-size:.65rem;color:var(--muted);margin-top:10px;"></div>
      </div>

      <!-- Wizard view (shown when drafting/editing a policy) -->
      <div id="pol-wizard-view" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
          <div>
            <div id="wz-policy-title" style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;"></div>
            <div id="wz-policy-meta" style="font-size:.6rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-top:2px;"></div>
          </div>
          <button class="btn btn-o" onclick="closePolicyWizard()">← Back to Policy List</button>
        </div>

        <div class="policy-grid">
          <div>
            <div class="wizard-steps" id="wzSteps">
              <div class="wstep active" id="ws0">1. Scope</div>
              <div class="wstep" id="ws1">2. Obligations</div>
              <div class="wstep" id="ws2">3. Procedures</div>
              <div class="wstep" id="ws3">4. Review</div>
            </div>

            <div class="wizard-pane on" id="wp0">
              <div class="policy-section">
                <div class="pol-h">1. Scope &amp; Purpose</div>
                <div class="pol-clause"><div class="pol-num">1.1</div><div class="pol-text" contenteditable="true" data-field="scope_1">This policy establishes the framework for managing all records created, received, or maintained by the Municipality in the course of conducting municipal business.</div></div>
                <div class="pol-clause"><div class="pol-num">1.2</div><div class="pol-text" contenteditable="true" data-field="scope_2">All records, regardless of format (paper, digital, audio-visual), are subject to this policy and applicable legislation including the <em>Freedom of Information and Protection of Privacy Act (FOIP)</em> and the <em>Municipal Government Act</em>.</div></div>
                <div class="pol-clause"><div class="pol-num">1.3</div><div class="pol-text" contenteditable="true" data-field="scope_3">This policy applies to all municipal employees, contractors, and volunteers who create or handle municipal records in the performance of their duties.</div></div>
              </div>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
                <button class="btn btn-o" onclick="saveWizardDraft()">Save Draft</button>
                <button class="btn btn-p" onclick="wzNext()">Next: Obligations →</button>
              </div>
            </div>

            <div class="wizard-pane" id="wp1">
              <div class="policy-section">
                <div class="pol-h">2. Legislative Obligations</div>
                <div class="pol-clause"><div class="pol-num">2.1</div><div class="pol-text" contenteditable="true" data-field="oblig_1"><strong>Access to Information Act:</strong> All records are subject to access requests. Records Technician must respond to requests within legislated timelines and apply appropriate exemptions in consultation with the Director of Data Management.</div></div>
                <div class="pol-clause"><div class="pol-num">2.2</div><div class="pol-text" contenteditable="true" data-field="oblig_2"><strong>Protection of Privacy Act (FOIP Part 2):</strong> Personal information collected, used, or disclosed must align with original collection purpose. Records containing personal data require additional security classification and restricted access controls.</div></div>
                <div class="pol-clause"><div class="pol-num">2.3</div><div class="pol-text" contenteditable="true" data-field="oblig_3"><strong>Municipal Government Act s.207:</strong> Financial records must be retained for a minimum of 7 years. Permanent retention applies to bylaws, minutes of Council, and land-related documents.</div></div>
                <div class="pol-clause"><div class="pol-num">2.4</div><div class="pol-text" contenteditable="true" data-field="oblig_4"><strong>Records Management Regulation (AR 225/2001):</strong> The County must maintain a retention and disposition schedule approved by the Provincial Archives of Alberta for all record series.</div></div>
              </div>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
                <button class="btn btn-o" onclick="wzPrev()">← Back</button>
                <button class="btn btn-o" onclick="saveWizardDraft()">Save Draft</button>
                <button class="btn btn-p" onclick="wzNext()">Next: Procedures →</button>
              </div>
            </div>

            <div class="wizard-pane" id="wp2">
              <div class="policy-section">
                <div class="pol-h">3. Core Procedures</div>
                <div class="pol-clause"><div class="pol-num">3.1</div><div class="pol-text" contenteditable="true" data-field="proc_1"><strong>Classification:</strong> All records must be classified according to the County's approved Functional Classification Scheme upon creation or receipt. The Records Management Technician shall maintain and update the scheme as business functions evolve.</div></div>
                <div class="pol-clause"><div class="pol-num">3.2</div><div class="pol-text" contenteditable="true" data-field="proc_2"><strong>Naming Convention:</strong> Electronic records shall follow the standard: [ClassCode]-[YYYY-MM-DD]-[Subject]-[Version]. Example: <code>FIN-2024-03-15-AnnualBudget-v2</code></div></div>
                <div class="pol-clause"><div class="pol-num">3.3</div><div class="pol-text" contenteditable="true" data-field="proc_3"><strong>Disposition:</strong> Records approaching disposition date must undergo a disposition review. Destruction requires signed authorization from the originating department head and Records Technician. A Certificate of Destruction must be retained permanently.</div></div>
                <div class="pol-clause"><div class="pol-num">3.4</div><div class="pol-text" contenteditable="true" data-field="proc_4"><strong>Vital Records:</strong> A Vital Records Register must be maintained identifying records essential to business continuity. These require off-site backup and are exempt from routine disposition.</div></div>
              </div>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
                <button class="btn btn-o" onclick="wzPrev()">← Back</button>
                <button class="btn btn-o" onclick="saveWizardDraft()">Save Draft</button>
                <button class="btn btn-p" onclick="wzNext()">Next: Review →</button>
              </div>
            </div>

            <div class="wizard-pane" id="wp3">
              <div class="policy-section">
                <div class="pol-h">4. Policy Review &amp; Approval</div>
                <div class="pol-clause"><div class="pol-num">4.1</div><div class="pol-text" contenteditable="true" data-field="rev_1">This policy shall be reviewed annually by the Records Management Technician and approved by the Director of Corporate Services.</div></div>
                <div class="pol-clause"><div class="pol-num">4.2</div><div class="pol-text" contenteditable="true" data-field="rev_2">All amendments require documentation of the change, rationale, and approver. Version history shall be maintained in the EDRMS under classification <strong>ADM-010 Policy &amp; Procedure Records</strong>.</div></div>
                <div class="pol-clause"><div class="pol-num">4.3</div><div class="pol-text" contenteditable="true" data-field="rev_3">Non-compliance with this policy may result in disciplinary action and potential regulatory penalties under FOIP. All staff shall receive records management training upon onboarding and annually thereafter.</div></div>
              </div>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
                <button class="btn btn-o" onclick="wzPrev()">← Back</button>
                <button class="btn btn-o" onclick="saveWizardDraft()">Save Draft</button>
                <button class="btn btn-s" onclick="publishPolicy()">✓ Approve &amp; Publish Policy</button>
              </div>
            </div>
          </div>

          <div>
            <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Policy Details</div>
            <div id="wz-sidebar" style="background:var(--white);border:1px solid var(--rule);padding:14px;font-size:.7rem;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════ AUDIT -->
    <div class="sec" id="sec-audit">
      <div class="ph">Audit Trail</div>
      <div class="ps">Complete tamper-evident log of all system actions — legislatively required under FOIP s.38</div>
      <div class="tb2">
        <select class="fsel" id="auditFilter" onchange="renderAudit()">
          <option value="">All Actions</option>
          <option value="CREATE">Create</option>
          <option value="EDIT">Edit</option>
          <option value="VIEW">View</option>
          <option value="DISPOSE">Dispose</option>
          <option value="CLASSIFY">Classify</option>
        </select>
        <button class="btn btn-o" onclick="exportAudit()">Export Log</button>
      </div>
      <div id="auditLog"></div>
    </div>

    <!-- ═══════════════════════════════════════════ ABOUT -->
    <div class="sec" id="sec-about">
      <div class="ph">About This Project</div>
      <div class="ps">Frontend portfolio project — Built by Ravi Patel</div>

      <div class="info-box">
        <strong>About This Project:</strong> I built this system from scratch as part of my application for a Records Management Technician role — because I wanted to show what I can actually do, not just describe it on paper. Every feature in here, from the classification taxonomy to the retention schedules and audit trail, reflects real research I did into Alberta municipal records legislation and EDRMS best practices. It took time to get right, but I felt that if I was going to apply for a role like this, I should be able to demonstrate the competency hands-on rather than just claim it.
      </div>

      <div class="about-grid">
        <div class="about-card">
          <h3>Competencies Demonstrated</h3>
          <ul>
            <li>Full EDRMS administration — creation, classification, retrieval, disposition</li>
            <li>Functional classification scheme design aligned with Alberta municipal standards</li>
            <li>Retention schedule development referencing real Alberta legislation (MGA, FOIP, AR 225/2001)</li>
            <li>Policy drafting using a structured wizard workflow</li>
            <li>Audit trail implementation per FOIP s.38 requirements</li>
            <li>Security classification (Public / Confidential / Restricted / Highly Confidential)</li>
            <li>Disposition workflow with authorization controls</li>
          </ul>
        </div>
        <div class="about-card">
          <h3>Legislative Knowledge Applied</h3>
          <ul>
            <li>Freedom of Information and Protection of Privacy Act (FOIP)</li>
            <li>Municipal Government Act RSA 2000</li>
            <li>Records Management Regulation AR 225/2001</li>
            <li>Local Authorities Election Act</li>
            <li>Access to Information Act</li>
            <li>Protection of Privacy Act</li>
            <li>ARMA International classification standards</li>
          </ul>
        </div>
        <div class="about-card">
          <h3>Tools &amp; Technologies Used</h3>
          <ul>
            <li><strong>HTML5</strong> — semantic structure and layout</li>
            <li><strong>CSS3</strong> — custom design system, responsive grid, animations</li>
            <li><strong>Vanilla JavaScript (ES6+)</strong> — all logic, data handling, and interactivity</li>
            <li><strong>Google Fonts</strong> — DM Mono &amp; Playfair Display typefaces</li>
            <li>No frameworks, no libraries, no templates — built entirely from scratch</li>
            <li>Frontend only — all data is in-memory JavaScript (no backend or database)</li>
          </ul>
        </div>
        <div class="about-card">
          <h3>Project Details</h3>
          <ul>
            <li><strong>Created by:</strong> Ravi Patel</li>
            <li><strong>Type:</strong> Frontend Web Application (Single HTML File)</li>
            <li><strong>Purpose:</strong> Portfolio project demonstrating municipal data management competency in a fully interactive live system</li>
            <li><strong>Features:</strong> Full CRUD records registry, real-time search &amp; filters, classification tree, retention scheduler, policy builder wizard, tamper-evident audit trail, CSV export</li>
            <li><strong>Responsive:</strong> Desktop and mobile compatible</li>
          </ul>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /app -->

<!-- ADD RECORD MODAL -->
<div class="ov" id="addRecModal">
  <div class="modal">
    <div class="mh"><div class="mt">Add New Record</div><button class="mc" onclick="closeModal('addRecModal')">×</button></div>
    <div class="mb">
      <div class="fr2">
        <div class="fg"><label class="fl">Record Title *</label><input class="fi" id="nr-title" placeholder="e.g. 2024 Annual Budget Report"></div>
        <div class="fg"><label class="fl">Classification *</label>
          <select class="fs" id="nr-class">
            <option value="Administrative">Administrative</option>
            <option value="Financial">Financial</option>
            <option value="Legal">Legal</option>
            <option value="Infrastructure">Infrastructure</option>
            <option value="Personnel">Personnel</option>
            <option value="Planning">Planning</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Sub-Classification</label><input class="fi" id="nr-subclass" placeholder="e.g. Budget Planning"></div>
        <div class="fg"><label class="fl">Security Level *</label>
          <select class="fs" id="nr-sec">
            <option value="Public">Public</option>
            <option value="Confidential">Confidential</option>
            <option value="Restricted">Restricted</option>
            <option value="Highly Confidential">Highly Confidential</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Department</label>
          <select class="fs" id="nr-dept">
            <option>Corporate Services</option><option>Finance</option><option>Infrastructure</option>
            <option>Planning & Development</option><option>Public Works</option><option>Administration</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Retention Period (years)</label>
          <select class="fs" id="nr-ret">
            <option value="1">1 year</option><option value="2">2 years</option><option value="3">3 years</option>
            <option value="5">5 years</option><option value="7" selected>7 years</option><option value="10">10 years</option><option value="25">25 years</option><option value="0">Permanent</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">Description</label><textarea class="fta" id="nr-desc" placeholder="Brief description of record content and purpose…"></textarea></div>
      <div class="fr2">
        <div class="fg"><label class="fl">Format</label>
          <select class="fs" id="nr-fmt">
            <option>Digital - PDF</option><option>Digital - Word</option><option>Digital - Excel</option>
            <option>Digital - Email</option><option>Paper</option><option>Mixed</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Vital Record?</label>
          <select class="fs" id="nr-vital">
            <option value="No">No</option><option value="Yes">Yes — include in Vital Records Register</option>
          </select>
        </div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('addRecModal')">Cancel</button>
      <button class="btn btn-g" onclick="addRecord()">Create Record</button>
    </div>
  </div>
</div>

<!-- VIEW RECORD MODAL -->
<div class="ov" id="viewRecModal">
  <div class="modal">
    <div class="mh"><div class="mt" id="vr-title">Record Detail</div><button class="mc" onclick="closeModal('viewRecModal')">×</button></div>
    <div class="mb" id="vr-body"></div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('viewRecModal')">Close</button>
      <button class="btn btn-d" id="vr-dispose-btn">Request Disposition</button>
    </div>
  </div>
</div>

<!-- ADD RETENTION MODAL -->
<div class="ov" id="addRetModal">
  <div class="modal">
    <div class="mh"><div class="mt">Add Retention Rule</div><button class="mc" onclick="closeModal('addRetModal')">×</button></div>
    <div class="mb">
      <div class="fr2">
        <div class="fg"><label class="fl">Record Series Name *</label><input class="fi" id="ret-name" placeholder="e.g. Council Meeting Minutes"></div>
        <div class="fg"><label class="fl">Classification</label>
          <select class="fs" id="ret-class">
            <option>Administrative</option><option>Financial</option><option>Legal</option>
            <option>Infrastructure</option><option>Personnel</option><option>Planning</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Active Retention (years)</label><input class="fi" id="ret-active" type="number" value="2" min="0"></div>
        <div class="fg"><label class="fl">Semi-Active (years)</label><input class="fi" id="ret-semi" type="number" value="5" min="0"></div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Final Disposition</label>
          <select class="fs" id="ret-disp">
            <option value="D">Destroy (D)</option><option value="A">Transfer to Archives (A)</option><option value="P">Permanent Retention (P)</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Legislative Authority</label><input class="fi" id="ret-leg" placeholder="e.g. MGA s.207"></div>
      </div>
      <div class="fg"><label class="fl">Notes</label><textarea class="fta" id="ret-notes" placeholder="Additional notes on this retention rule…"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('addRetModal')">Cancel</button>
      <button class="btn btn-g" onclick="addRetention()">Add Rule</button>
    </div>
  </div>
</div>

<!-- EDIT RECORD MODAL -->
<div class="ov" id="editRecModal">
  <div class="modal">
    <div class="mh"><div class="mt">Edit Record</div><button class="mc" onclick="closeModal('editRecModal')">×</button></div>
    <div class="mb">
      <input type="hidden" id="er-id">
      <div class="fr2">
        <div class="fg"><label class="fl">Record Title *</label><input class="fi" id="er-title"></div>
        <div class="fg"><label class="fl">Classification *</label>
          <select class="fs" id="er-class">
            <option>Administrative</option><option>Financial</option><option>Legal</option>
            <option>Infrastructure</option><option>Personnel</option><option>Planning</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Sub-Classification</label><input class="fi" id="er-sub" placeholder="e.g. Council Records"></div>
        <div class="fg"><label class="fl">Security Level</label>
          <select class="fs" id="er-sec">
            <option>Public</option><option>Confidential</option><option>Restricted</option><option>Highly Confidential</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Status</label>
          <select class="fs" id="er-status">
            <option>Active</option><option>Under Review</option><option>Pending Disposition</option><option>Archived</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Department</label>
          <select class="fs" id="er-dept">
            <option>Corporate Services</option><option>Finance</option><option>Infrastructure</option>
            <option>Planning & Development</option><option>Public Works</option><option>Administration</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Retention Period (years)</label>
          <select class="fs" id="er-ret">
            <option value="1">1 year</option><option value="2">2 years</option><option value="3">3 years</option>
            <option value="5">5 years</option><option value="7">7 years</option><option value="10">10 years</option>
            <option value="25">25 years</option><option value="0">Permanent</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Format</label>
          <select class="fs" id="er-fmt">
            <option>Digital - PDF</option><option>Digital - Word</option><option>Digital - Excel</option>
            <option>Digital - Email</option><option>Paper</option><option>Mixed</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Vital Record?</label>
          <select class="fs" id="er-vital">
            <option value="No">No</option><option value="Yes">Yes — Vital Record</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">Description</label><textarea class="fta" id="er-desc"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('editRecModal')">Cancel</button>
      <button class="btn btn-g" onclick="saveEditRecord()">Save Changes</button>
    </div>
  </div>
</div>

<!-- EDIT RETENTION MODAL -->
<div class="ov" id="editRetModal">
  <div class="modal">
    <div class="mh"><div class="mt">Edit Retention Rule</div><button class="mc" onclick="closeModal('editRetModal')">×</button></div>
    <div class="mb">
      <input type="hidden" id="etr-id">
      <div class="fr2">
        <div class="fg"><label class="fl">Record Series Name *</label><input class="fi" id="etr-name"></div>
        <div class="fg"><label class="fl">Classification</label>
          <select class="fs" id="etr-class">
            <option>Administrative</option><option>Financial</option><option>Legal</option>
            <option>Infrastructure</option><option>Personnel</option><option>Planning</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Active Retention (years)</label><input class="fi" id="etr-active" type="number" min="0"></div>
        <div class="fg"><label class="fl">Semi-Active (years)</label><input class="fi" id="etr-semi" type="number" min="0"></div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Final Disposition</label>
          <select class="fs" id="etr-disp">
            <option value="D">Destroy (D)</option><option value="A">Transfer to Archives (A)</option><option value="P">Permanent Retention (P)</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Legislative Authority</label><input class="fi" id="etr-leg" placeholder="e.g. MGA s.207"></div>
      </div>
      <div class="fg"><label class="fl">Notes</label><textarea class="fta" id="etr-notes"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('editRetModal')">Cancel</button>
      <button class="btn btn-g" onclick="saveEditRetention()">Save Changes</button>
    </div>
  </div>
</div>

<!-- NEW POLICY MODAL -->
<div class="ov" id="newPolModal">
  <div class="modal">
    <div class="mh"><div class="mt">New Policy</div><button class="mc" onclick="closeModal('newPolModal')">×</button></div>
    <div class="mb">
      <div class="fr2">
        <div class="fg"><label class="fl">Policy Title *</label><input class="fi" id="np-title" placeholder="e.g. Records Management Policy"></div>
        <div class="fg"><label class="fl">Category *</label>
          <select class="fs" id="np-cat">
            <option>Records Management</option>
            <option>Information Security</option>
            <option>Access & Privacy (FOIP)</option>
            <option>Retention & Disposition</option>
            <option>Vital Records</option>
            <option>HR & Personnel</option>
            <option>Financial Management</option>
            <option>IT & Digital Records</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Policy Owner</label>
          <select class="fs" id="np-owner">
            <option>Records Management Technician</option>
            <option>Director of Corporate Services</option>
            <option>Director of Finance</option>
            <option>IT Manager</option>
            <option>HR Manager</option>
            <option>Legal Counsel</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Review Cycle</label>
          <select class="fs" id="np-review">
            <option value="1">Annual (1 year)</option>
            <option value="2">Biennial (2 years)</option>
            <option value="3">Every 3 years</option>
            <option value="5">Every 5 years</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Legislative Authority</label><input class="fi" id="np-leg" placeholder="e.g. FOIP, MGA s.207, AR 225/2001"></div>
        <div class="fg"><label class="fl">Applies To</label>
          <select class="fs" id="np-scope">
            <option>All Staff</option>
            <option>Records & Admin Only</option>
            <option>Management</option>
            <option>IT Department</option>
            <option>Finance Department</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">Purpose / Description</label><textarea class="fta" id="np-desc" placeholder="Brief description of what this policy covers and why it exists…"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('newPolModal')">Cancel</button>
      <button class="btn btn-g" onclick="createNewPolicy()">Create &amp; Open in Wizard →</button>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// DATA STORE
// ═══════════════════════════════════════════════════════════

let records = [
  {id:'MDS-2024-001',title:'2024 Council Meeting Minutes - January',class:'Administrative',sub:'Council Records',sec:'Public',dept:'Administration',status:'Active',created:'2024-01-15',retYears:10,desc:'Official minutes of the January 2024 regular Council meeting.',fmt:'Digital - PDF',vital:'Yes'},
  {id:'MDS-2024-002',title:'Annual Financial Statements 2023',class:'Financial',sub:'Annual Reporting',sec:'Public',dept:'Finance',status:'Archived',created:'2024-03-01',retYears:7,desc:'Audited financial statements for fiscal year 2023.',fmt:'Digital - PDF',vital:'Yes'},
  {id:'MDS-2024-003',title:'Employee Benefits Policy v3.2',class:'Personnel',sub:'HR Policies',sec:'Confidential',dept:'Administration',status:'Active',created:'2024-02-10',retYears:7,desc:'Updated employee benefits and compensation policy.',fmt:'Digital - Word',vital:'No'},
  {id:'MDS-2024-004',title:'Road Maintenance Contract - Spring 2024',class:'Infrastructure',sub:'Contracts',sec:'Restricted',dept:'Infrastructure',status:'Under Review',created:'2024-04-05',retYears:7,desc:'Contract with municipal road services provider for spring maintenance.',fmt:'Digital - PDF',vital:'No'},
  {id:'MDS-2024-005',title:'Land Use Bylaw Amendment 2024-03',class:'Legal',sub:'Bylaws',sec:'Public',dept:'Planning & Development',status:'Active',created:'2024-05-20',retYears:0,desc:'Amendment to Land Use Bylaw regarding agricultural zoning.',fmt:'Digital - PDF',vital:'Yes'},
  {id:'MDS-2024-006',title:'Access to Information Request - File 24-019',class:'Legal',sub:'FOIP Requests',sec:'Highly Confidential',dept:'Corporate Services',status:'Active',created:'2024-06-01',retYears:3,desc:'ATI request from media outlet re: infrastructure spending.',fmt:'Digital - Email',vital:'No'},
  {id:'MDS-2024-007',title:'2024-2026 Capital Budget Plan',class:'Financial',sub:'Budget Planning',sec:'Confidential',dept:'Finance',status:'Under Review',created:'2024-07-15',retYears:7,desc:'Three-year capital expenditure plan for infrastructure and services.',fmt:'Digital - Excel',vital:'Yes'},
  {id:'MDS-2024-008',title:'Subdivision Application - Block 14 Lot 22',class:'Planning',sub:'Development Applications',sec:'Public',dept:'Planning & Development',status:'Active',created:'2024-08-03',retYears:10,desc:'Residential subdivision application for 14 new lots.',fmt:'Mixed',vital:'No'},
  {id:'MDS-2024-009',title:'Health & Safety Incident Report Q2',class:'Administrative',sub:'Safety Records',sec:'Restricted',dept:'Public Works',status:'Active',created:'2024-09-10',retYears:10,desc:'Quarterly workplace incident and near-miss summary report.',fmt:'Digital - PDF',vital:'No'},
  {id:'MDS-2024-010',title:'Water Treatment Plant Inspection 2024',class:'Infrastructure',sub:'Inspection Reports',sec:'Restricted',dept:'Infrastructure',status:'Pending Disposition',created:'2022-11-01',retYears:5,desc:'Annual inspection of municipal water treatment facility.',fmt:'Digital - PDF',vital:'No'},
];

let retentionRules = [
  {id:'RR-001',name:'Council Meeting Minutes',class:'Administrative',active:2,semi:8,disp:'P',leg:'MGA s.207, AR 225/2001',notes:'Official record of Council decisions. Permanent retention.'},
  {id:'RR-002',name:'Annual Financial Statements',class:'Financial',active:3,semi:4,disp:'A',leg:'MGA s.276',notes:'Transfer to Provincial Archives after 7 years.'},
  {id:'RR-003',name:'General Financial Records',class:'Financial',active:2,semi:5,disp:'D',leg:'MGA s.276, Income Tax Act',notes:'Includes invoices, receipts, AP/AR records.'},
  {id:'RR-004',name:'Bylaws & Resolutions',class:'Legal',active:5,semi:0,disp:'P',leg:'MGA s.207(1)',notes:'Permanent retention. Official legislative acts of Council.'},
  {id:'RR-005',name:'FOIP Requests & Responses',class:'Legal',active:2,semi:1,disp:'D',leg:'FOIP s.38, AR 186/2008',notes:'3-year total. Destroy after review period.'},
  {id:'RR-006',name:'Employee Personnel Files',class:'Personnel',active:7,semi:0,disp:'D',leg:'PIPA, Employment Standards Code',notes:'Retain 7 years after separation. Contains personal information — FOIP Part 2 applies.'},
  {id:'RR-007',name:'Capital Project Records',class:'Infrastructure',active:10,semi:0,disp:'A',leg:'MGA s.207, Municipal Engineering',notes:'Transfer to Archives. Infrastructure records with long-term liability.'},
  {id:'RR-008',name:'Development Applications',class:'Planning',active:5,semi:5,disp:'A',leg:'Land Titles Act, MGA',notes:'Transfer to Archives. Permanent land use record.'},
];

let auditLog = [
  {ts:'2024-09-15 14:32',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-009',note:'Created new Health & Safety Incident Report Q2'},
  {ts:'2024-09-10 09:15',user:'Ravi Patel',action:'CLASSIFY',target:'MDS-2024-008',note:'Reclassified from General to Planning > Development Applications'},
  {ts:'2024-08-20 11:02',user:'System',action:'DISPOSE',target:'MDS-2022-047',note:'Auto-flagged for disposition — retention period expired'},
  {ts:'2024-08-15 16:45',user:'Ravi Patel',action:'VIEW',target:'MDS-2024-006',note:'Accessed FOIP request file for response preparation'},
  {ts:'2024-08-03 10:30',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-008',note:'Created Subdivision Application record'},
  {ts:'2024-07-22 13:10',user:'Director Corporate Services',action:'EDIT',target:'RR-006',note:'Updated Personnel Files retention from 6 to 7 years per legal review'},
  {ts:'2024-07-15 09:00',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-007',note:'Created 2024-2026 Capital Budget Plan'},
  {ts:'2024-06-30 15:30',user:'System',action:'DISPOSE',target:'MDS-2021-031',note:'Certificate of Destruction issued — Financial record past retention'},
  {ts:'2024-06-01 08:45',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-006',note:'Created FOIP Request file — marked Highly Confidential'},
  {ts:'2024-05-20 14:00',user:'Ravi Patel',action:'CLASSIFY',target:'MDS-2024-005',note:'Classified as Legal > Bylaws — Permanent retention applied'},
];

let classTree = [
  {code:'ADM',name:'Administrative',color:'g',items:[
    {code:'ADM-010',name:'Policy & Procedure Records',count:12,sec:'Internal'},
    {code:'ADM-020',name:'Council & Committee Records',count:48,sec:'Public'},
    {code:'ADM-030',name:'Correspondence & Communications',count:230,sec:'Mixed'},
    {code:'ADM-040',name:'Safety & Risk Management',count:34,sec:'Restricted'},
  ]},
  {code:'FIN',name:'Financial',color:'b',items:[
    {code:'FIN-010',name:'Budget & Financial Plans',count:22,sec:'Confidential'},
    {code:'FIN-020',name:'Annual Financial Statements',count:15,sec:'Public'},
    {code:'FIN-030',name:'Accounts Payable & Receivable',count:1840,sec:'Confidential'},
    {code:'FIN-040',name:'Grant Administration',count:28,sec:'Confidential'},
  ]},
  {code:'LEG',name:'Legal',color:'r',items:[
    {code:'LEG-010',name:'Bylaws & Resolutions',count:310,sec:'Public'},
    {code:'LEG-020',name:'Contracts & Agreements',count:94,sec:'Restricted'},
    {code:'LEG-030',name:'FOIP Requests',count:47,sec:'Highly Confidential'},
    {code:'LEG-040',name:'Litigation Records',count:8,sec:'Highly Confidential'},
  ]},
  {code:'INF',name:'Infrastructure',items:[
    {code:'INF-010',name:'Capital Projects',count:56,sec:'Restricted'},
    {code:'INF-020',name:'Inspection Reports',count:145,sec:'Restricted'},
    {code:'INF-030',name:'Asset Management',count:78,sec:'Internal'},
  ]},
  {code:'PER',name:'Personnel',color:'r',items:[
    {code:'PER-010',name:'Employee Files',count:43,sec:'Highly Confidential'},
    {code:'PER-020',name:'Recruitment Records',count:88,sec:'Confidential'},
    {code:'PER-030',name:'Training & Development',count:34,sec:'Confidential'},
  ]},
  {code:'PLN',name:'Planning',color:'g',items:[
    {code:'PLN-010',name:'Development Applications',count:203,sec:'Public'},
    {code:'PLN-020',name:'Land Use Bylaws',count:12,sec:'Public'},
    {code:'PLN-030',name:'Environmental Studies',count:29,sec:'Restricted'},
  ]},
];

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
function launchApp(){
  document.getElementById('splash').classList.add('out');
  setTimeout(()=>{
    document.getElementById('app').classList.add('show');
    initDashboard();
    renderRecords();
    renderRetention();
    renderClassTree();
    renderAudit();
    renderPolIndex();
  },700);
}

function showTab(id,btn){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  btn.classList.add('on');
}

function statCardClick(s){
  const tabIndex = {dashboard:1,records:2,classify:3,retention:4,policy:5,audit:6,about:7};
  const idx = tabIndex[s.tab] || 1;
  const btn = document.querySelector('.nav-tab:nth-child('+idx+')');
  if(!btn) return;

  if(s.tab === 'records'){
    document.getElementById('recSearch').value = '';
    document.getElementById('recStatusF').value = '';
    document.getElementById('recClassF').value = '';
    window._vitalFilter = false;

    if(s.filter){
      if(s.filter.status){
        document.getElementById('recStatusF').value = s.filter.status;
      }
      if(s.filter.vital){
        window._vitalFilter = true;
      }
    }
    renderRecords();
  }

  showTab(s.tab, btn);
  window.scrollTo({top:0,behavior:'smooth'});

  const counts = {
    'Total Records':       'Showing all '+records.length+' records',
    'Active Records':      'Filtered to '+records.filter(r=>r.status==='Active').length+' active records',
    'Pending Disposition': 'Filtered to '+records.filter(r=>r.status==='Pending Disposition').length+' records pending disposition',
    'Vital Records':       'Filtered to '+records.filter(r=>r.vital==='Yes').length+' vital records',
    'Retention Rules':     'Viewing '+retentionRules.length+' retention rules',
    'Audit Entries':       'Viewing '+auditLog.length+' audit log entries',
  };
  notify(counts[s.l] || 'Navigated to '+s.tab, 'info');
}

// ═══════════════════════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════════════════════
function initDashboard(){
  const d = new Date();
  document.getElementById('dash-date').textContent = d.toLocaleDateString('en-CA',{year:'numeric',month:'long',day:'numeric'});

  const stats = [
    {n:records.length,           l:'Total Records',        cls:'',  tab:'records',  filter:null,           hint:'View all records'},
    {n:records.filter(r=>r.status==='Active').length,            l:'Active Records',       cls:'g', tab:'records',  filter:{status:'Active'},      hint:'View active records'},
    {n:records.filter(r=>r.status==='Pending Disposition').length,l:'Pending Disposition', cls:'r', tab:'records',  filter:{status:'Pending Disposition'}, hint:'View records pending disposition'},
    {n:records.filter(r=>r.vital==='Yes').length,                l:'Vital Records',        cls:'b', tab:'records',  filter:{vital:true},           hint:'View vital records'},
    {n:retentionRules.length,    l:'Retention Rules',      cls:'',  tab:'retention',filter:null,           hint:'View retention schedule'},
    {n:auditLog.length,          l:'Audit Entries',        cls:'g', tab:'audit',    filter:null,           hint:'View audit trail'},
  ];
  document.getElementById('dashStats').innerHTML = stats.map(s=>
    `<div class="sc ${s.cls}" onclick="statCardClick(${JSON.stringify(s).replace(/"/g,"'")})" title="${s.hint}">
      <div class="sc-n">${s.n}</div>
      <div class="sc-l">${s.l}</div>
      <div class="sc-arrow">→ ${s.hint}</div>
    </div>`
  ).join('');

  // Status chart
  const statuses = ['Active','Under Review','Pending Disposition','Archived'];
  const statusColors = {'Active':'var(--sage)','Under Review':'var(--gold)','Pending Disposition':'var(--rust)','Archived':'var(--slate)'};
  let sch = '';
  statuses.forEach(st=>{
    const cnt = records.filter(r=>r.status===st).length;
    const pct = Math.round(cnt/records.length*100);
    sch += `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;font-size:.68rem;margin-bottom:3px">
        <span>${st}</span><span style="color:var(--muted)">${cnt} (${pct}%)</span>
      </div>
      <div class="prog-wrap"><div class="prog-bar" style="width:${pct}%;background:${statusColors[st]}"></div></div>
    </div>`;
  });
  document.getElementById('statusChart').innerHTML = sch;

  // Disposition chart
  const classes = ['Administrative','Financial','Legal','Infrastructure','Personnel','Planning'];
  let dch = '';
  classes.forEach(c=>{
    const cnt = records.filter(r=>r.class===c&&r.status==='Pending Disposition').length+Math.floor(Math.random()*3);
    dch += `<div style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;font-size:.65rem;margin-bottom:3px">
        <span>${c}</span><span style="color:var(--muted)">${cnt}</span>
      </div>
      <div class="prog-wrap"><div class="prog-bar ${cnt>3?'r':''}" style="width:${Math.min(cnt*20,100)}%"></div></div>
    </div>`;
  });
  document.getElementById('dispChart').innerHTML = dch;

  // Recent activity
  document.getElementById('recentActivity').innerHTML = auditLog.slice(0,5).map(e=>logEntry(e)).join('');
}

// ═══════════════════════════════════════════════════════════
// RECORDS
// ═══════════════════════════════════════════════════════════
function renderRecords(){
  window._vitalFilter = window._vitalFilter || false;
  const q = (document.getElementById('recSearch').value||'').toLowerCase();
  const sf = document.getElementById('recStatusF').value;
  const cf = document.getElementById('recClassF').value;

  let filtered = records.filter(r=>{
    const matchQ = !q || r.id.toLowerCase().includes(q)||r.title.toLowerCase().includes(q)||(r.sub||'').toLowerCase().includes(q);
    const matchS = !sf || r.status===sf;
    const matchC = !cf || r.class===cf;
    const matchV = !window._vitalFilter || r.vital==='Yes';
    return matchQ&&matchS&&matchC&&matchV;
  });

  const retDate = r=>{
    if(r.retYears===0) return '<span style="color:var(--sage);font-size:.65rem">Permanent</span>';
    const d = new Date(r.created); d.setFullYear(d.getFullYear()+r.retYears);
    const diff = (d-new Date())/(1000*60*60*24*365);
    const color = diff<0.5?'var(--rust)':diff<1?'var(--gold)':'var(--muted)';
    return `<span style="color:${color};font-size:.68rem">${d.toISOString().split('T')[0]}</span>`;
  };

  document.getElementById('recTbody').innerHTML = filtered.map(r=>`
    <tr>
      <td><input type="checkbox" class="rec-chk" value="${r.id}" style="cursor:pointer"></td>
      <td style="font-size:.65rem;color:var(--muted)">${r.id}</td>
      <td><strong style="font-size:.74rem">${r.title}</strong>${r.vital==='Yes'?'<span style="color:var(--rust);margin-left:6px;font-size:.6rem">★ VITAL</span>':''}</td>
      <td><span style="font-size:.68rem">${r.class}</span><br><span style="color:var(--muted);font-size:.62rem">${r.sub||''}</span></td>
      <td>${secBadge(r.sec)}</td>
      <td>${statusBadge(r.status)}</td>
      <td style="font-size:.68rem;color:var(--muted)">${r.created}</td>
      <td>${retDate(r)}</td>
      <td style="white-space:nowrap">
        <button class="act-link" data-rid="${r.id}" onclick="viewRecord(this.dataset.rid)">View</button>
        <button class="act-link" style="color:var(--slate)" data-rid="${r.id}" onclick="editRecord(this.dataset.rid)">Edit</button>
        <button class="act-link" style="color:var(--rust)" data-rid="${r.id}" onclick="deleteRecord(this.dataset.rid)">Delete</button>
        <button class="act-link" data-rid="${r.id}" onclick="disposeRecord(this.dataset.rid)">Dispose</button>
      </td>
    </tr>
  `).join('');
  document.getElementById('recCount').innerHTML = `Showing ${filtered.length} of ${records.length} records${window._vitalFilter?' &nbsp;<span style="background:var(--slate);color:var(--paper);font-size:.56rem;padding:2px 8px;letter-spacing:.06em">★ VITAL FILTER <span onclick="window._vitalFilter=false;renderRecords()" style="cursor:pointer;margin-left:4px;opacity:.7">✕</span></span>':''}`;
}

function secBadge(s){
  const m={'Public':'pub','Confidential':'con','Restricted':'res','Highly Confidential':'hi'};
  return `<span class="bdg bdg-${m[s]||'pub'}">${s}</span>`;
}
function statusBadge(s){
  const m={'Active':'act','Under Review':'rev','Pending Disposition':'dis','Archived':'arc'};
  return `<span class="bdg bdg-${m[s]||'act'}">${s}</span>`;
}

function viewRecord(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('vr-title').textContent = r.title;
  document.getElementById('vr-body').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
      ${dRow('Record ID',r.id)}${dRow('Classification',r.class+' > '+(r.sub||'–'))}
      ${dRow('Security',r.sec)}${dRow('Status',r.status)}
      ${dRow('Department',r.dept)}${dRow('Format',r.fmt)}
      ${dRow('Created',r.created)}${dRow('Retention',r.retYears===0?'Permanent':r.retYears+' years')}
      ${dRow('Vital Record',r.vital)}${dRow('Disposition Action',r.retYears===0?'Permanent (P)':'Destroy (D)')}
    </div>
    <div style="font-size:.62rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Description</div>
    <div style="font-size:.74rem;line-height:1.6;padding:12px;background:var(--cream);border:1px solid var(--rule)">${r.desc}</div>
  `;
  document.getElementById('vr-dispose-btn').onclick = ()=>{ closeModal('viewRecModal'); disposeRecord(id); };
  addAuditEntry('VIEW',id,`Viewed record: ${r.title}`);
  openModal('viewRecModal');
}

function dRow(k,v){
  return `<div><div style="font-size:.58rem;letter-spacing:.09em;text-transform:uppercase;color:var(--muted);margin-bottom:3px">${k}</div><div style="font-size:.74rem">${v}</div></div>`;
}

function addRecord(){
  const title = document.getElementById('nr-title').value.trim();
  if(!title){ notify('Please enter a record title.','err'); return; }
  const yr = parseInt(document.getElementById('nr-ret').value);
  const id = 'MDS-'+new Date().getFullYear()+'-'+String(records.length+1).padStart(3,'0');
  const r = {
    id, title,
    class: document.getElementById('nr-class').value,
    sub: document.getElementById('nr-subclass').value,
    sec: document.getElementById('nr-sec').value,
    dept: document.getElementById('nr-dept').value,
    status: 'Active',
    created: new Date().toISOString().split('T')[0],
    retYears: yr,
    desc: document.getElementById('nr-desc').value||'No description provided.',
    fmt: document.getElementById('nr-fmt').value,
    vital: document.getElementById('nr-vital').value==='Yes'?'Yes':'No',
  };
  records.unshift(r);
  addAuditEntry('CREATE',id,`Created new record: ${title}`);
  closeModal('addRecModal');
  document.getElementById('nr-title').value='';
  renderRecords();
  initDashboard();
  notify(`Record ${id} created successfully.`,'ok');
}

function editRecord(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('er-id').value = r.id;
  document.getElementById('er-title').value = r.title;
  document.getElementById('er-class').value = r.class;
  document.getElementById('er-sub').value = r.sub||'';
  document.getElementById('er-sec').value = r.sec;
  document.getElementById('er-status').value = r.status;
  document.getElementById('er-dept').value = r.dept;
  document.getElementById('er-ret').value = r.retYears;
  document.getElementById('er-fmt').value = r.fmt;
  document.getElementById('er-vital').value = r.vital;
  document.getElementById('er-desc').value = r.desc;
  openModal('editRecModal');
}

function saveEditRecord(){
  const id = document.getElementById('er-id').value;
  const r = records.find(x=>x.id===id);
  if(!r) return;
  const oldTitle = r.title;
  r.title   = document.getElementById('er-title').value.trim()||r.title;
  r.class   = document.getElementById('er-class').value;
  r.sub     = document.getElementById('er-sub').value;
  r.sec     = document.getElementById('er-sec').value;
  r.status  = document.getElementById('er-status').value;
  r.dept    = document.getElementById('er-dept').value;
  r.retYears= parseInt(document.getElementById('er-ret').value)||r.retYears;
  r.fmt     = document.getElementById('er-fmt').value;
  r.vital   = document.getElementById('er-vital').value;
  r.desc    = document.getElementById('er-desc').value;
  addAuditEntry('EDIT', id, `Record updated: ${oldTitle}`);
  closeModal('editRecModal');
  renderRecords();
  initDashboard();
  notify(`Record ${id} updated successfully.`, 'ok');
}

function deleteRecord(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  if(!confirm(`Permanently delete record "${r.title}" (${id})? This action cannot be undone.`)) return;
  records = records.filter(x=>x.id!==id);
  addAuditEntry('DISPOSE', id, `Record permanently deleted: ${r.title}`);
  renderRecords();
  initDashboard();
  notify(`Record ${id} deleted.`, 'ok');
}

function selectAll(){
  document.querySelectorAll('.rec-chk').forEach(c=>c.checked=true);
  document.getElementById('chkAll').checked=true;
}
function clearSel(){
  document.querySelectorAll('.rec-chk').forEach(c=>c.checked=false);
  document.getElementById('chkAll').checked=false;
}
function toggleAll(el){
  document.querySelectorAll('.rec-chk').forEach(c=>c.checked=el.checked);
}
function bulkDelete(){
  const sel = [...document.querySelectorAll('.rec-chk:checked')].map(c=>c.value);
  if(!sel.length){ notify('No records selected.','err'); return; }
  if(!confirm(`Permanently delete ${sel.length} selected record(s)? This cannot be undone.`)) return;
  sel.forEach(id=>{
    const r = records.find(x=>x.id===id);
    if(r) addAuditEntry('DISPOSE',id,`Bulk deleted: ${r.title}`);
  });
  records = records.filter(r=>!sel.includes(r.id));
  renderRecords();
  initDashboard();
  notify(`${sel.length} record(s) deleted.`, 'ok');
}

function exportRecords(){
  const sel = [...document.querySelectorAll('.rec-chk:checked')].map(c=>c.value);
  const toExport = sel.length ? records.filter(r=>sel.includes(r.id)) : records;
  let csv = 'Record ID,Title,Classification,Sub-Class,Security,Status,Department,Format,Vital,Created,Retention Years,Description\n';
  toExport.forEach(r=>{
    csv += `"${r.id}","${r.title}","${r.class}","${r.sub||''}","${r.sec}","${r.status}","${r.dept}","${r.fmt}","${r.vital}","${r.created}",${r.retYears},"${r.desc}"\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = 'MDS_Records_Export.csv'; a.click();
  notify(`Exported ${toExport.length} record(s) as CSV.`,'ok');
}

function disposeRecord(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  if(r.status==='Pending Disposition'||r.status==='Archived'){
    notify('Record is already in disposition or archived.','info'); return;
  }
  r.status = 'Pending Disposition';
  addAuditEntry('DISPOSE',id,`Disposition requested for: ${r.title}`);
  renderRecords();
  initDashboard();
  notify(`Record ${id} flagged for disposition review.`,'ok');
}

// ═══════════════════════════════════════════════════════════
// RETENTION
// ═══════════════════════════════════════════════════════════
function renderRetention(){
  const dispLabel = {'D':'Destroy','A':'Transfer to Archives','P':'Permanent Retention'};
  const dispColor = {'D':'r','A':'b','P':'g'};
  document.getElementById('retGrid').innerHTML = retentionRules.map(r=>`
    <div class="ret-card ${dispColor[r.disp]||''}">
      <div class="ret-cat">${r.class} · ${r.id}</div>
      <div class="ret-name">${r.name}</div>
      <div class="ret-row"><span class="ret-key">Active Period</span><span class="ret-val">${r.active} year${r.active!==1?'s':''}</span></div>
      <div class="ret-row"><span class="ret-key">Semi-Active</span><span class="ret-val">${r.semi>0?r.semi+' year'+(r.semi!==1?'s':''):'—'}</span></div>
      <div class="ret-row"><span class="ret-key">Total Retention</span><span class="ret-val">${r.disp==='P'?'Permanent':(r.active+r.semi)+' years'}</span></div>
      <div class="ret-row"><span class="ret-key">Final Disposition</span><span class="ret-val" style="color:${r.disp==='D'?'var(--rust)':r.disp==='P'?'var(--sage)':'var(--slate)'}">${dispLabel[r.disp]}</span></div>
      <div class="ret-row"><span class="ret-key">Authority</span><span class="ret-val" style="font-size:.62rem">${r.leg}</span></div>
      ${r.notes?`<div style="font-size:.64rem;color:var(--muted);margin-top:8px;line-height:1.5">${r.notes}</div>`:''}
      <div style="display:flex;gap:8px;margin-top:12px;border-top:1px solid var(--cream);padding-top:10px">
        <button class="btn btn-o" style="font-size:.62rem;padding:5px 10px;flex:1" data-rid="${r.id}" onclick="editRetention(this.dataset.rid)">&#10002; Edit</button>
        <button class="btn btn-d" style="font-size:.62rem;padding:5px 10px;flex:1" data-rid="${r.id}" onclick="deleteRetention(this.dataset.rid)">&#10005; Delete</button>
      </div>
    </div>
  `).join('');
}

function addRetention(){
  const name = document.getElementById('ret-name').value.trim();
  if(!name){ notify('Please enter a record series name.','err'); return; }
  retentionRules.push({
    id:'RR-'+String(retentionRules.length+1).padStart(3,'0'),
    name,
    class: document.getElementById('ret-class').value,
    active: parseInt(document.getElementById('ret-active').value)||2,
    semi: parseInt(document.getElementById('ret-semi').value)||0,
    disp: document.getElementById('ret-disp').value,
    leg: document.getElementById('ret-leg').value||'TBD',
    notes: document.getElementById('ret-notes').value,
  });
  addAuditEntry('CREATE','RR-NEW',`Added retention rule: ${name}`);
  closeModal('addRetModal');
  document.getElementById('ret-name').value='';
  renderRetention();
  notify('Retention rule added to schedule.','ok');
}

function editRetention(id){
  const r = retentionRules.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('etr-id').value   = r.id;
  document.getElementById('etr-name').value  = r.name;
  document.getElementById('etr-class').value = r.class;
  document.getElementById('etr-active').value= r.active;
  document.getElementById('etr-semi').value  = r.semi;
  document.getElementById('etr-disp').value  = r.disp;
  document.getElementById('etr-leg').value   = r.leg;
  document.getElementById('etr-notes').value = r.notes||'';
  openModal('editRetModal');
}

function saveEditRetention(){
  const id = document.getElementById('etr-id').value;
  const r = retentionRules.find(x=>x.id===id);
  if(!r) return;
  r.name   = document.getElementById('etr-name').value.trim()||r.name;
  r.class  = document.getElementById('etr-class').value;
  r.active = parseInt(document.getElementById('etr-active').value)||r.active;
  r.semi   = parseInt(document.getElementById('etr-semi').value)||0;
  r.disp   = document.getElementById('etr-disp').value;
  r.leg    = document.getElementById('etr-leg').value||r.leg;
  r.notes  = document.getElementById('etr-notes').value;
  addAuditEntry('EDIT', id, `Retention rule updated: ${r.name}`);
  closeModal('editRetModal');
  renderRetention();
  notify(`Retention rule ${id} updated.`, 'ok');
}

function deleteRetention(id){
  const r = retentionRules.find(x=>x.id===id);
  if(!r) return;
  if(!confirm(`Delete retention rule "${r.name}" (${id})?`)) return;
  retentionRules = retentionRules.filter(x=>x.id!==id);
  addAuditEntry('DISPOSE', id, `Retention rule deleted: ${r.name}`);
  renderRetention();
  notify(`Retention rule ${id} deleted.`, 'ok');
}

function exportRetention(){
  let csv = 'ID,Record Series,Classification,Active (yrs),Semi-Active (yrs),Disposition,Authority\n';
  retentionRules.forEach(r=>{
    csv += `"${r.id}","${r.name}","${r.class}",${r.active},${r.semi},"${r.disp}","${r.leg}"\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='MDS_Retention_Schedule.csv'; a.click();
  notify('Retention schedule exported as CSV.','ok');
}

// ═══════════════════════════════════════════════════════════
// CLASSIFICATION TREE
// ═══════════════════════════════════════════════════════════
function renderClassTree(){
  document.getElementById('classTree').innerHTML = classTree.map(c=>`
    <div class="tree-node">
      <div class="tree-parent" onclick="toggleTree('${c.code}'); showClassDetail(${JSON.stringify(c).replace(/"/g,'&quot;')})">
        <span style="color:var(--muted);font-size:.8rem">▸</span>
        <strong>${c.code}</strong> — ${c.name}
        <span style="margin-left:auto;font-size:.6rem;color:var(--muted)">${c.items.length} series</span>
      </div>
      <div class="tree-children" id="tree-${c.code}">
        ${c.items.map(i=>`
          <div class="tree-child" onclick="showSubDetail(${JSON.stringify(i).replace(/"/g,'&quot;')})">
            <span style="color:var(--muted);font-size:.68rem">${i.code} — ${i.name}</span>
            <span class="bdg" style="background:var(--cream);color:var(--muted)">${i.count}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

function toggleTree(code){
  const el = document.getElementById('tree-'+code);
  el.classList.toggle('open');
}

function showClassDetail(c){
  document.getElementById('classDetail').innerHTML = `
    <div style="font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px">${c.code}</div>
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;margin-bottom:14px">${c.name} Records</div>
    <div style="font-size:.68rem;color:var(--muted);margin-bottom:14px">${c.items.length} record series · ${c.items.reduce((a,i)=>a+i.count,0)} total records</div>
    ${c.items.map(i=>`
      <div style="padding:10px;border:1px solid var(--rule);margin-bottom:8px;background:var(--cream);cursor:pointer" onclick="showSubDetail(${JSON.stringify(i).replace(/"/g,"'")})">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <strong style="font-size:.72rem">${i.code}</strong>
          <span class="bdg bdg-${i.sec==='Public'?'pub':i.sec==='Confidential'?'con':i.sec==='Restricted'?'res':'hi'}">${i.sec}</span>
        </div>
        <div style="font-size:.7rem">${i.name}</div>
        <div style="font-size:.6rem;color:var(--muted);margin-top:4px">${i.count} records</div>
      </div>
    `).join('')}
  `;
}

function showSubDetail(i){
  document.getElementById('classDetail').innerHTML = `
    <div style="font-size:.58rem;color:var(--muted);margin-bottom:4px;letter-spacing:.08em;text-transform:uppercase">Record Series Detail</div>
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;margin-bottom:12px">${i.name}</div>
    ${dRow('Classification Code',i.code)}
    <div style="height:10px"></div>
    ${dRow('Security Level',i.sec)}
    <div style="height:10px"></div>
    ${dRow('Total Records',i.count+' records')}
    <div style="height:16px"></div>
    <button class="btn btn-g" style="font-size:.65rem" onclick="document.getElementById('recClassF').value='${i.code.split('-')[0]==='ADM'?'Administrative':i.code.split('-')[0]==='FIN'?'Financial':i.code.split('-')[0]==='LEG'?'Legal':i.code.split('-')[0]==='INF'?'Infrastructure':i.code.split('-')[0]==='PER'?'Personnel':'Planning'}';showTab('records',document.querySelector('.nav-tab:nth-child(2)'))">View Records in This Series →</button>
  `;
}

// ═══════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════
function logEntry(e){
  const icons={'CREATE':'✚','EDIT':'✎','VIEW':'◉','DISPOSE':'⊗','CLASSIFY':'⊞'};
  const cls={'CREATE':'li-add','EDIT':'li-edit','VIEW':'li-view','DISPOSE':'li-dis','CLASSIFY':'li-edit'};
  return `<div class="log-entry">
    <div class="log-ts">${e.ts}</div>
    <div class="log-icon ${cls[e.action]||'li-view'}">${icons[e.action]||'•'}</div>
    <div class="log-text"><span class="log-user">${e.user}</span> · <span style="color:var(--gold)">${e.action}</span> · <span style="color:var(--muted);font-size:.65rem">${e.target}</span><br>${e.note}</div>
  </div>`;
}

function renderAudit(){
  const f = document.getElementById('auditFilter').value;
  const filtered = f ? auditLog.filter(e=>e.action===f) : auditLog;
  document.getElementById('auditLog').innerHTML = filtered.map(e=>logEntry(e)).join('');
}

function addAuditEntry(action,target,note){
  const now = new Date();
  const ts = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  auditLog.unshift({ts,user:'Ravi Patel',action,target,note});
  if(document.getElementById('sec-audit').classList.contains('on')) renderAudit();
}

function exportAudit(){
  let csv='Timestamp,User,Action,Record ID,Notes\n';
  auditLog.forEach(e=>{ csv+=`"${e.ts}","${e.user}","${e.action}","${e.target}","${e.note}"\n`; });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='MDS_Audit_Log.csv'; a.click();
  notify('Audit log exported as CSV.','ok');
}

// ═══════════════════════════════════════════════════════════
// POLICY DATA STORE
// ═══════════════════════════════════════════════════════════
let policies = [
  {id:'POL-001',title:'Records Management Policy v1.0',cat:'Records Management',owner:'Records Management Technician',status:'Draft',created:'2024-09-15',reviewYears:1,leg:'FOIP, MGA s.207, AR 225/2001',scope:'All Staff',desc:'Core policy governing creation, classification, retention and disposition of all municipal records.',wzStep:0},
  {id:'POL-002',title:'Retention & Disposition Procedure',cat:'Retention & Disposition',owner:'Records Management Technician',status:'Approved',created:'2024-01-10',reviewYears:2,leg:'AR 225/2001, MGA s.276',scope:'Records & Admin Only',desc:'Procedures for applying retention schedules and authorizing disposition of municipal records.',wzStep:3},
  {id:'POL-003',title:'FOIP Request Handling Procedure',cat:'Access & Privacy (FOIP)',owner:'Director of Corporate Services',status:'Approved',created:'2023-11-01',reviewYears:1,leg:'FOIP s.7, s.38',scope:'All Staff',desc:'Step-by-step procedures for receiving, processing and responding to access to information requests.',wzStep:3},
  {id:'POL-004',title:'Vital Records Register',cat:'Vital Records',owner:'Records Management Technician',status:'Under Review',created:'2024-08-20',reviewYears:1,leg:'MGA, Business Continuity Act',scope:'Records & Admin Only',desc:'Identifies and protects records essential to business continuity and emergency operations.',wzStep:2},
  {id:'POL-005',title:'Classification Scheme Guidelines',cat:'Records Management',owner:'Records Management Technician',status:'Approved',created:'2023-06-15',reviewYears:3,leg:'ARMA International, AR 225/2001',scope:'All Staff',desc:'Guidelines for applying the functional classification scheme to all municipal record series.',wzStep:3},
];

let activePolId = null;
let wzStep = 0;

// ═══════════════════════════════════════════════════════════
// POLICY WIZARD
// ═══════════════════════════════════════════════════════════
function openNewPolicyModal(){
  document.getElementById('np-title').value = '';
  document.getElementById('np-desc').value = '';
  openModal('newPolModal');
}

function createNewPolicy(){
  const title = document.getElementById('np-title').value.trim();
  if(!title){ notify('Please enter a policy title.','err'); return; }
  const today = new Date().toISOString().split('T')[0];
  const id = 'POL-' + String(policies.length + 1).padStart(3,'0');
  const pol = {
    id,
    title,
    cat:         document.getElementById('np-cat').value,
    owner:       document.getElementById('np-owner').value,
    status:      'Draft',
    created:     today,
    reviewYears: parseInt(document.getElementById('np-review').value)||1,
    leg:         document.getElementById('np-leg').value||'TBD',
    scope:       document.getElementById('np-scope').value,
    desc:        document.getElementById('np-desc').value||'No description provided.',
    wzStep:      0,
  };
  policies.unshift(pol);
  addAuditEntry('CREATE', id, 'New policy drafted: ' + title);
  closeModal('newPolModal');
  renderPolIndex();
  notify('Policy ' + id + ' created. Opening wizard…','ok');
  setTimeout(()=> openPolicyWizard(id), 300);
}

function openPolicyWizard(id){
  const pol = policies.find(p=>p.id===id);
  if(!pol) return;
  activePolId = id;
  wzStep = pol.wzStep || 0;

  // Show wizard, hide list
  document.getElementById('pol-list-view').style.display = 'none';
  document.getElementById('pol-wizard-view').style.display = 'block';

  // Set header
  document.getElementById('wz-policy-title').textContent = pol.title;
  document.getElementById('wz-policy-meta').textContent = pol.id + ' · ' + pol.cat + ' · ' + pol.status;

  // Reset wizard steps UI
  for(let i=0;i<4;i++){
    const ws = document.getElementById('ws'+i);
    ws.className = 'wstep';
    if(i < wzStep) ws.classList.add('done');
    else if(i === wzStep) ws.classList.add('active');
  }
  // Reset panes
  for(let i=0;i<4;i++){
    const wp = document.getElementById('wp'+i);
    wp.className = 'wizard-pane' + (i===wzStep?' on':'');
  }

  // Render sidebar
  renderWzSidebar(pol);

  addAuditEntry('VIEW', id, 'Opened policy wizard: ' + pol.title);
  window.scrollTo({top:0,behavior:'smooth'});
}

function closePolicyWizard(){
  document.getElementById('pol-wizard-view').style.display = 'none';
  document.getElementById('pol-list-view').style.display = 'block';
  activePolId = null;
  renderPolIndex();
}

function renderWzSidebar(pol){
  const reviewDate = new Date(pol.created);
  reviewDate.setFullYear(reviewDate.getFullYear() + pol.reviewYears);
  const statusColor = pol.status==='Approved'?'var(--sage)':pol.status==='Draft'?'var(--gold)':'var(--slate)';
  document.getElementById('wz-sidebar').innerHTML = `
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Policy ID',pol.id)}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Category',pol.cat)}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Owner',pol.owner)}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Applies To',pol.scope)}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Status','<span style="color:'+statusColor+';font-weight:500">'+pol.status+'</span>')}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Created',pol.created)}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;border-bottom:1px solid var(--cream)">${dRow('Next Review',reviewDate.toISOString().split('T')[0])}</div>
    <div style="height:8px"></div>
    <div style="padding:8px 0;">${dRow('Authority',pol.leg)}</div>
    <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--rule)">
      <div style="font-size:.58rem;letter-spacing:.09em;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Purpose</div>
      <div style="font-size:.68rem;line-height:1.5;color:var(--ink)">${pol.desc}</div>
    </div>
  `;
}

function wzNext(){
  if(wzStep<3){
    document.getElementById('wp'+wzStep).classList.remove('on');
    document.getElementById('ws'+wzStep).classList.remove('active');
    document.getElementById('ws'+wzStep).classList.add('done');
    wzStep++;
    document.getElementById('wp'+wzStep).classList.add('on');
    document.getElementById('ws'+wzStep).classList.add('active');
    if(activePolId){
      const pol = policies.find(p=>p.id===activePolId);
      if(pol) pol.wzStep = Math.max(pol.wzStep||0, wzStep);
    }
  }
}

function wzPrev(){
  if(wzStep>0){
    document.getElementById('wp'+wzStep).classList.remove('on');
    document.getElementById('ws'+wzStep).classList.remove('active');
    wzStep--;
    document.getElementById('ws'+wzStep).classList.remove('done');
    document.getElementById('wp'+wzStep).classList.add('on');
    document.getElementById('ws'+wzStep).classList.add('active');
  }
}

function saveWizardDraft(){
  if(activePolId){
    const pol = policies.find(p=>p.id===activePolId);
    if(pol){
      pol.wzStep = wzStep;
      if(pol.status==='Draft') pol.status='Draft'; // keep as draft
      addAuditEntry('EDIT', activePolId, 'Policy draft saved at step '+(wzStep+1)+': '+pol.title);
    }
  }
  notify('Draft saved successfully.','ok');
}

function publishPolicy(){
  for(let i=0;i<4;i++){
    document.getElementById('ws'+i).classList.remove('active');
    document.getElementById('ws'+i).classList.add('done');
  }
  if(activePolId){
    const pol = policies.find(p=>p.id===activePolId);
    if(pol){
      pol.status = 'Approved';
      pol.wzStep = 3;
      document.getElementById('wz-policy-meta').textContent = pol.id + ' · ' + pol.cat + ' · Approved';
      renderWzSidebar(pol);
      addAuditEntry('CREATE', activePolId, 'Policy approved & published: '+pol.title);
    }
  }
  notify('Policy approved and published to EDRMS.','ok');
}

function sendPolicyForReview(){
  if(activePolId){
    const pol = policies.find(p=>p.id===activePolId);
    if(pol){
      pol.status = 'Under Review';
      document.getElementById('wz-policy-meta').textContent = pol.id + ' · ' + pol.cat + ' · Under Review';
      renderWzSidebar(pol);
      addAuditEntry('EDIT', activePolId, 'Policy submitted for review: '+pol.title);
      notify('Policy submitted for review.','info');
    }
  }
}

function deletePolicy(id){
  const pol = policies.find(p=>p.id===id);
  if(!pol) return;
  if(!confirm('Permanently delete policy "'+pol.title+'" ('+id+')? This cannot be undone.')) return;
  policies = policies.filter(p=>p.id!==id);
  addAuditEntry('DISPOSE', id, 'Policy deleted: '+pol.title);
  renderPolIndex();
  notify('Policy '+id+' deleted.','ok');
}

function renderPolIndex(){
  const f = (document.getElementById('polStatusF')||{}).value || '';
  const filtered = f ? policies.filter(p=>p.status===f) : policies;
  const statusColor = s => s==='Approved'?'var(--sage)':s==='Draft'?'var(--gold)':'var(--slate)';
  const progressPct = p => Math.round(((p.wzStep||0)+1)/4*100);

  document.getElementById('polTbody').innerHTML = filtered.map(p=>`
    <tr>
      <td style="font-size:.65rem;color:var(--muted)">${p.id}</td>
      <td>
        <strong style="font-size:.74rem">${p.title}</strong>
        <div style="margin-top:4px"><div class="prog-wrap" style="max-width:120px"><div class="prog-bar ${p.status==='Approved'?'g':''}" style="width:${progressPct(p)}%"></div></div></div>
        <div style="font-size:.58rem;color:var(--muted);margin-top:2px">Step ${(p.wzStep||0)+1} of 4 complete</div>
      </td>
      <td style="font-size:.68rem">${p.cat}</td>
      <td style="font-size:.68rem;color:var(--muted)">${p.owner}</td>
      <td><span class="bdg" style="background:${p.status==='Approved'?'#d4edda':p.status==='Draft'?'#fff3cd':'#d1ecf1'};color:${p.status==='Approved'?'#155724':p.status==='Draft'?'#856404':'#0c5460'}">${p.status}</span></td>
      <td style="font-size:.68rem;color:var(--muted)">${p.created}</td>
      <td style="font-size:.68rem;color:var(--muted)">${getReviewDate(p)}</td>
      <td style="white-space:nowrap">
        <button class="act-link" data-pid="${p.id}" onclick="openPolicyWizard(this.dataset.pid)">✎ Edit</button>
        <button class="act-link" style="color:${statusColor(p.status)}" data-pid="${p.id}" onclick="quickStatusChange(this.dataset.pid)">${p.status==='Draft'?'→ Review':p.status==='Under Review'?'→ Approve':'✓ Done'}</button>
        <button class="act-link" style="color:var(--rust)" data-pid="${p.id}" onclick="deletePolicy(this.dataset.pid)">Delete</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="8" style="text-align:center;padding:28px;color:var(--muted);font-size:.72rem">No policies found.</td></tr>';

  document.getElementById('polCount').textContent = 'Showing '+filtered.length+' of '+policies.length+' policies';
}

function getReviewDate(pol){
  const d = new Date(pol.created);
  d.setFullYear(d.getFullYear() + (pol.reviewYears||1));
  const diff = (d - new Date()) / (1000*60*60*24);
  const color = diff < 0 ? 'var(--rust)' : diff < 90 ? 'var(--gold)' : 'var(--muted)';
  return '<span style="color:'+color+'">'+d.toISOString().split('T')[0]+'</span>';
}

function quickStatusChange(id){
  const pol = policies.find(p=>p.id===id);
  if(!pol) return;
  if(pol.status==='Draft') pol.status='Under Review';
  else if(pol.status==='Under Review') pol.status='Approved';
  addAuditEntry('EDIT', id, 'Policy status updated to '+pol.status+': '+pol.title);
  renderPolIndex();
  notify('Policy '+id+' status updated to '+pol.status+'.','ok');
}

function exportPolicies(){
  let csv = 'ID,Title,Category,Owner,Status,Created,Review Cycle (yrs),Authority,Scope,Description\n';
  policies.forEach(p=>{
    csv += '"'+p.id+'","'+p.title+'","'+p.cat+'","'+p.owner+'","'+p.status+'","'+p.created+'",'+p.reviewYears+',"'+(p.leg||'')+'","'+p.scope+'","'+p.desc+'"\n';
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='MDS_Policy_Index.csv'; a.click();
  notify('Policy index exported as CSV.','ok');
}

// ═══════════════════════════════════════════════════════════
// MODALS & NOTIFICATIONS
// ═══════════════════════════════════════════════════════════
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.ov').forEach(ov=>{
  ov.addEventListener('click',e=>{ if(e.target===ov) ov.classList.remove('open'); });
});

function notify(msg,type='ok'){
  const el = document.getElementById('notif');
  const item = document.createElement('div');
  item.className = `notif-item ni-${type}`;
  item.textContent = msg;
  el.appendChild(item);
  setTimeout(()=>item.style.opacity='0',3000);
  setTimeout(()=>item.remove(),3400);
}

// ── set date ──
document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-CA',{year:'numeric',month:'long',day:'numeric'});
</script>
</body>
</html>
