  <div class="sp-seal">
    <svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="10" y="8" width="32" height="40" rx="2" stroke="#b8853a" stroke-width="1.5"/>
      <rect x="14" y="14" width="20" height="2" rx="1" fill="#b8853a"/>
      <rect x="14" y="20" width="20" height="2" rx="1" fill="#b8853a"/>
      <rect x="14" y="26" width="14" height="2" rx="1" fill="#b8853a"/>
      <rect x="14" y="32" width="16" height="2" rx="1" fill="#b8853a"/>
      <circle cx="42" cy="42" r="10" fill="#b8853a"/>
      <path d="M37 42l3 3 5-6" stroke="#12191f" stroke-width="1.8" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="sp-title">Municipal Data Management</div>
  <div class="sp-sub">Electronic Document & Records Management System</div>
  <div class="sp-desc">A fully functional frontend portfolio project demonstrating municipal data management, retention scheduling, classification taxonomy, policy development, and audit trail management.</div>
  <button class="sp-btn" onclick="launchApp()">Launch System →</button>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="tb-brand"><em>MDS</em> Municipal Data Management</div>
    <div class="tb-meta">Municipal Services · Records &amp; Data Management</div>
    <div class="tb-user">
      <span>Ravi Patel</span>
      <span class="tb-badge">Records Tech</span>
    </div>
  </div>

  <div class="nav" id="mainNav">
    <button class="nav-tab on" onclick="showTab('dashboard',this)">Dashboard</button>
    <button class="nav-tab" onclick="showTab('records',this)">Records Registry</button>
    <button class="nav-tab" onclick="showTab('classify',this)">Classification</button>
    <button class="nav-tab" onclick="showTab('retention',this)">Retention Schedule</button>
    <button class="nav-tab" onclick="showTab('policy',this)">Policy Builder</button>
    <button class="nav-tab" onclick="showTab('audit',this)">Audit Trail</button>
    <button class="nav-tab" onclick="showTab('about',this)">About Project</button>
  </div>

  <div class="content">
    <div id="notif"></div>

    <!-- ═══════════════════════════════════════════ DASHBOARD -->
    <div class="sec on" id="sec-dashboard">
      <div class="ph">Records Management Dashboard</div>
      <div class="ps">Municipal Services · Records &amp; Data Management Department · <span id="dash-date"></span></div>

      <div class="info-box">
        <strong>System Note:</strong> This system was built as a hands-on portfolio project to demonstrate practical EDRMS competency. All records, retention rules, and classifications below reflect real municipal records categories based on Alberta's <em>Municipal Government Act</em> and the <em>Records Management Regulation (AR 225/2001)</em>.
      </div>

      <div class="stats" id="dashStats"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Records by Status</div>
          <div id="statusChart"></div>
        </div>
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Disposition Due This Quarter</div>
          <div id="dispChart"></div>
        </div>
      </div>

      <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Recent Activity</div>
      <div id="recentActivity"></div>
    </div>

    <!-- ═══════════════════════════════════════════ RECORDS -->
    <div class="sec" id="sec-records">
      <div class="ph">Records Registry</div>
      <div class="ps">Create · Classify · Retrieve · Manage disposition of all corporate records</div>

      <div class="tb2">
        <input type="text" id="recSearch" placeholder="Search records by title, ID, or classification…" oninput="renderRecords()">
        <select class="fsel" id="recStatusF" onchange="renderRecords()">
          <option value="">All Statuses</option>
          <option value="Active">Active</option>
          <option value="Under Review">Under Review</option>
          <option value="Pending Disposition">Pending Disposition</option>
          <option value="Archived">Archived</option>
        </select>
        <select class="fsel" id="recClassF" onchange="renderRecords()">
          <option value="">All Classifications</option>
          <option value="Administrative">Administrative</option>
          <option value="Financial">Financial</option>
          <option value="Legal">Legal</option>
          <option value="Infrastructure">Infrastructure</option>
          <option value="Personnel">Personnel</option>
          <option value="Planning">Planning</option>
        </select>
        <button class="btn btn-g" onclick="openModal('addRecModal')">+ Add Record</button>
      </div>

      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Record ID</th><th>Title</th><th>Classification</th>
            <th>Security</th><th>Status</th><th>Created</th><th>Retention Ends</th><th>Actions</th>
          </tr></thead>
          <tbody id="recTbody"></tbody>
        </table>
      </div>
      <div id="recCount" style="font-size:.65rem;color:var(--muted);margin-top:10px;"></div>
    </div>

    <!-- ═══════════════════════════════════════════ CLASSIFICATION -->
    <div class="sec" id="sec-classify">
      <div class="ph">Classification Scheme</div>
      <div class="ps">Hierarchical taxonomy aligned with Municipal Government Act functional categories</div>

      <div class="info-box">
        <strong>Alberta Municipal Classification Standard:</strong> This scheme follows the <em>ARMA International</em> functional classification framework adapted for Alberta municipalities. Top-level classes reflect primary municipal functions; subclasses reflect record series within each function.
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Functional Classification Tree</div>
          <div style="background:var(--white);border:1px solid var(--rule);padding:16px;">
            <div class="tree" id="classTree"></div>
          </div>
        </div>
        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Selected Class Detail</div>
          <div id="classDetail" style="background:var(--white);border:1px solid var(--rule);padding:16px;min-height:300px;">
            <div style="color:var(--muted);font-size:.72rem;padding-top:40px;text-align:center;">← Select a classification from the tree</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════ RETENTION -->
    <div class="sec" id="sec-retention">
      <div class="ph">Retention & Disposition Schedule</div>
      <div class="ps">Managed in accordance with Alberta Records Management Regulation AR 225/2001</div>

      <div class="info-box">
        <strong>Legislative Basis:</strong> Retention periods set per <em>Municipal Government Act RSA 2000</em>, <em>Local Authorities Election Act</em>, <em>Freedom of Information and Protection of Privacy Act (FOIP)</em>, and <em>Municipal Government Act</em> s.207. Disposition actions: Destroy (D), Transfer to Archives (A), or Permanent Retention (P).
      </div>

      <div class="tb2">
        <button class="btn btn-g" onclick="openModal('addRetModal')">+ Add Retention Rule</button>
        <button class="btn btn-o" onclick="exportRetention()">Export Schedule</button>
      </div>

      <div class="ret-grid" id="retGrid"></div>
    </div>

    <!-- ═══════════════════════════════════════════ POLICY -->
    <div class="sec" id="sec-policy">
      <div class="ph">Policy Builder</div>
      <div class="ps">Draft, review and publish records management policies and procedures</div>

      <div style="display:grid;grid-template-columns:1fr 280px;gap:20px;">
        <div>
          <div class="wizard-steps" id="wzSteps">
            <div class="wstep active" id="ws0">1. Scope</div>
            <div class="wstep" id="ws1">2. Obligations</div>
            <div class="wstep" id="ws2">3. Procedures</div>
            <div class="wstep" id="ws3">4. Review</div>
          </div>

          <div class="wizard-pane on" id="wp0">
            <div class="policy-section">
              <div class="pol-h">1. Scope & Purpose</div>
              <div class="pol-clause"><div class="pol-num">1.1</div><div class="pol-text">This policy establishes the framework for managing all records created, received, or maintained by the Municipality in the course of conducting municipal business.<span class="pol-tag" style="--tag:#d4edda;color:#155724;">Active</span></div></div>
              <div class="pol-clause"><div class="pol-num">1.2</div><div class="pol-text">All records, regardless of format (paper, digital, audio-visual), are subject to this policy and applicable legislation including the <em>Freedom of Information and Protection of Privacy Act (FOIP)</em> and the <em>Municipal Government Act</em>.</div></div>
              <div class="pol-clause"><div class="pol-num">1.3</div><div class="pol-text">This policy applies to all municipal employees, contractors, and volunteers who create or handle municipal records in the performance of their duties.<span class="pol-tag" style="--tag:#fff3cd;color:#856404;">Needs Review</span></div></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
              <button class="btn btn-p" onclick="wzNext()">Next: Obligations →</button>
            </div>
          </div>

          <div class="wizard-pane" id="wp1">
            <div class="policy-section">
              <div class="pol-h">2. Legislative Obligations</div>
              <div class="pol-clause"><div class="pol-num">2.1</div><div class="pol-text"><strong>Access to Information Act:</strong> All records are subject to access requests. Records Technician must respond to requests within legislated timelines and apply appropriate exemptions in consultation with the Director of Data Management.</div></div>
              <div class="pol-clause"><div class="pol-num">2.2</div><div class="pol-text"><strong>Protection of Privacy Act (FOIP Part 2):</strong> Personal information collected, used, or disclosed must align with original collection purpose. Records containing personal data require additional security classification and restricted access controls.</div></div>
              <div class="pol-clause"><div class="pol-num">2.3</div><div class="pol-text"><strong>Municipal Government Act s.207:</strong> Financial records must be retained for a minimum of 7 years. Permanent retention applies to bylaws, minutes of Council, and land-related documents.</div></div>
              <div class="pol-clause"><div class="pol-num">2.4</div><div class="pol-text"><strong>Records Management Regulation (AR 225/2001):</strong> The County must maintain a retention and disposition schedule approved by the Provincial Archives of Alberta for all record series.</div></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
              <button class="btn btn-o" onclick="wzPrev()">← Back</button>
              <button class="btn btn-p" onclick="wzNext()">Next: Procedures →</button>
            </div>
          </div>

          <div class="wizard-pane" id="wp2">
            <div class="policy-section">
              <div class="pol-h">3. Core Procedures</div>
              <div class="pol-clause"><div class="pol-num">3.1</div><div class="pol-text"><strong>Classification:</strong> All records must be classified according to the County's approved Functional Classification Scheme upon creation or receipt. The Records Management Technician shall maintain and update the scheme as business functions evolve.</div></div>
              <div class="pol-clause"><div class="pol-num">3.2</div><div class="pol-text"><strong>Naming Convention:</strong> Electronic records shall follow the standard: [ClassCode]-[YYYY-MM-DD]-[Subject]-[Version]. Example: <code>FIN-2024-03-15-AnnualBudget-v2</code></div></div>
              <div class="pol-clause"><div class="pol-num">3.3</div><div class="pol-text"><strong>Disposition:</strong> Records approaching disposition date must undergo a disposition review. Destruction requires signed authorization from the originating department head and Records Technician. A Certificate of Destruction must be retained permanently.</div></div>
              <div class="pol-clause"><div class="pol-num">3.4</div><div class="pol-text"><strong>Vital Records:</strong> A Vital Records Register must be maintained identifying records essential to business continuity. These require off-site backup and are exempt from routine disposition.</div></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
              <button class="btn btn-o" onclick="wzPrev()">← Back</button>
              <button class="btn btn-p" onclick="wzNext()">Next: Review →</button>
            </div>
          </div>

          <div class="wizard-pane" id="wp3">
            <div class="policy-section">
              <div class="pol-h">4. Policy Review & Approval</div>
              <div class="pol-clause"><div class="pol-num">4.1</div><div class="pol-text">This policy shall be reviewed annually by the Records Management Technician and approved by the Director of Corporate Services.</div></div>
              <div class="pol-clause"><div class="pol-num">4.2</div><div class="pol-text">All amendments require documentation of the change, rationale, and approver. Version history shall be maintained in the EDRMS under classification <strong>ADM-010 Policy & Procedure Records</strong>.</div></div>
              <div class="pol-clause"><div class="pol-num">4.3</div><div class="pol-text">Non-compliance with this policy may result in disciplinary action and potential regulatory penalties under FOIP. All staff shall receive records management training upon onboarding and annually thereafter.</div></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
              <button class="btn btn-o" onclick="wzPrev()">← Back</button>
              <button class="btn btn-s" onclick="publishPolicy()">✓ Mark Policy Complete</button>
            </div>
          </div>
        </div>

        <div>
          <div style="font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Policy Index</div>
          <div id="polIndex" style="background:var(--white);border:1px solid var(--rule);padding:14px;font-size:.7rem;"></div>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════ AUDIT -->
    <div class="sec" id="sec-audit">
      <div class="ph">Audit Trail</div>
      <div class="ps">Complete tamper-evident log of all system actions — legislatively required under FOIP s.38</div>
      <div class="tb2">
        <select class="fsel" id="auditFilter" onchange="renderAudit()">
          <option value="">All Actions</option>
          <option value="CREATE">Create</option>
          <option value="EDIT">Edit</option>
          <option value="VIEW">View</option>
          <option value="DISPOSE">Dispose</option>
          <option value="CLASSIFY">Classify</option>
        </select>
        <button class="btn btn-o" onclick="exportAudit()">Export Log</button>
      </div>
      <div id="auditLog"></div>
    </div>

    <!-- ═══════════════════════════════════════════ ABOUT -->
    <div class="sec" id="sec-about">
      <div class="ph">About This Project</div>
      <div class="ps">Frontend portfolio project — Built by Ravi Patel</div>

      <div class="info-box">
        <strong>What makes this unprecedented:</strong> This is a fully functional EDRMS built from scratch as a job application portfolio piece — demonstrating the exact competencies the role requires rather than just claiming them. No prior candidate for a records management role has submitted a working system as part of their application.
      </div>

      <div class="about-grid">
        <div class="about-card">
          <h3>Competencies Demonstrated</h3>
          <ul>
            <li>Full EDRMS administration — creation, classification, retrieval, disposition</li>
            <li>Functional classification scheme design aligned with Alberta municipal standards</li>
            <li>Retention schedule development referencing real Alberta legislation (MGA, FOIP, AR 225/2001)</li>
            <li>Policy drafting using a structured wizard workflow</li>
            <li>Audit trail implementation per FOIP s.38 requirements</li>
            <li>Security classification (Public / Confidential / Restricted / Highly Confidential)</li>
            <li>Disposition workflow with authorization controls</li>
          </ul>
        </div>
        <div class="about-card">
          <h3>Legislative Knowledge Applied</h3>
          <ul>
            <li>Freedom of Information and Protection of Privacy Act (FOIP)</li>
            <li>Municipal Government Act RSA 2000</li>
            <li>Records Management Regulation AR 225/2001</li>
            <li>Local Authorities Election Act</li>
            <li>Access to Information Act</li>
            <li>Protection of Privacy Act</li>
            <li>ARMA International classification standards</li>
          </ul>
        </div>
        <div class="about-card">
          <h3>Tools &amp; Technologies Used</h3>
          <ul>
            <li><strong>HTML5</strong> — semantic structure and layout</li>
            <li><strong>CSS3</strong> — custom design system, responsive grid, animations</li>
            <li><strong>Vanilla JavaScript (ES6+)</strong> — all logic, data handling, and interactivity</li>
            <li><strong>Google Fonts</strong> — DM Mono &amp; Playfair Display typefaces</li>
            <li>No frameworks, no libraries, no templates — built entirely from scratch</li>
            <li>Frontend only — all data is in-memory JavaScript (no backend or database)</li>
          </ul>
        </div>
        <div class="about-card">
          <h3>Project Details</h3>
          <ul>
            <li><strong>Created by:</strong> Ravi Patel</li>
            <li><strong>Type:</strong> Frontend Web Application (Single HTML File)</li>
            <li><strong>Purpose:</strong> Portfolio project demonstrating municipal data management competency in a fully interactive live system</li>
            <li><strong>Features:</strong> Full CRUD records registry, real-time search &amp; filters, classification tree, retention scheduler, policy builder wizard, tamper-evident audit trail, CSV export</li>
            <li><strong>Responsive:</strong> Desktop and mobile compatible</li>
          </ul>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /app -->

<!-- ADD RECORD MODAL -->
<div class="ov" id="addRecModal">
  <div class="modal">
    <div class="mh"><div class="mt">Add New Record</div><button class="mc" onclick="closeModal('addRecModal')">×</button></div>
    <div class="mb">
      <div class="fr2">
        <div class="fg"><label class="fl">Record Title *</label><input class="fi" id="nr-title" placeholder="e.g. 2024 Annual Budget Report"></div>
        <div class="fg"><label class="fl">Classification *</label>
          <select class="fs" id="nr-class">
            <option value="Administrative">Administrative</option>
            <option value="Financial">Financial</option>
            <option value="Legal">Legal</option>
            <option value="Infrastructure">Infrastructure</option>
            <option value="Personnel">Personnel</option>
            <option value="Planning">Planning</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Sub-Classification</label><input class="fi" id="nr-subclass" placeholder="e.g. Budget Planning"></div>
        <div class="fg"><label class="fl">Security Level *</label>
          <select class="fs" id="nr-sec">
            <option value="Public">Public</option>
            <option value="Confidential">Confidential</option>
            <option value="Restricted">Restricted</option>
            <option value="Highly Confidential">Highly Confidential</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Department</label>
          <select class="fs" id="nr-dept">
            <option>Corporate Services</option><option>Finance</option><option>Infrastructure</option>
            <option>Planning & Development</option><option>Public Works</option><option>Administration</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Retention Period (years)</label>
          <select class="fs" id="nr-ret">
            <option value="1">1 year</option><option value="2">2 years</option><option value="3">3 years</option>
            <option value="5">5 years</option><option value="7" selected>7 years</option><option value="10">10 years</option><option value="25">25 years</option><option value="0">Permanent</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">Description</label><textarea class="fta" id="nr-desc" placeholder="Brief description of record content and purpose…"></textarea></div>
      <div class="fr2">
        <div class="fg"><label class="fl">Format</label>
          <select class="fs" id="nr-fmt">
            <option>Digital - PDF</option><option>Digital - Word</option><option>Digital - Excel</option>
            <option>Digital - Email</option><option>Paper</option><option>Mixed</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Vital Record?</label>
          <select class="fs" id="nr-vital">
            <option value="No">No</option><option value="Yes">Yes — include in Vital Records Register</option>
          </select>
        </div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('addRecModal')">Cancel</button>
      <button class="btn btn-g" onclick="addRecord()">Create Record</button>
    </div>
  </div>
</div>

<!-- VIEW RECORD MODAL -->
<div class="ov" id="viewRecModal">
  <div class="modal">
    <div class="mh"><div class="mt" id="vr-title">Record Detail</div><button class="mc" onclick="closeModal('viewRecModal')">×</button></div>
    <div class="mb" id="vr-body"></div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('viewRecModal')">Close</button>
      <button class="btn btn-d" id="vr-dispose-btn">Request Disposition</button>
    </div>
  </div>
</div>

<!-- ADD RETENTION MODAL -->
<div class="ov" id="addRetModal">
  <div class="modal">
    <div class="mh"><div class="mt">Add Retention Rule</div><button class="mc" onclick="closeModal('addRetModal')">×</button></div>
    <div class="mb">
      <div class="fr2">
        <div class="fg"><label class="fl">Record Series Name *</label><input class="fi" id="ret-name" placeholder="e.g. Council Meeting Minutes"></div>
        <div class="fg"><label class="fl">Classification</label>
          <select class="fs" id="ret-class">
            <option>Administrative</option><option>Financial</option><option>Legal</option>
            <option>Infrastructure</option><option>Personnel</option><option>Planning</option>
          </select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Active Retention (years)</label><input class="fi" id="ret-active" type="number" value="2" min="0"></div>
        <div class="fg"><label class="fl">Semi-Active (years)</label><input class="fi" id="ret-semi" type="number" value="5" min="0"></div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Final Disposition</label>
          <select class="fs" id="ret-disp">
            <option value="D">Destroy (D)</option><option value="A">Transfer to Archives (A)</option><option value="P">Permanent Retention (P)</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Legislative Authority</label><input class="fi" id="ret-leg" placeholder="e.g. MGA s.207"></div>
      </div>
      <div class="fg"><label class="fl">Notes</label><textarea class="fta" id="ret-notes" placeholder="Additional notes on this retention rule…"></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-o" onclick="closeModal('addRetModal')">Cancel</button>
      <button class="btn btn-g" onclick="addRetention()">Add Rule</button>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// DATA STORE
// ═══════════════════════════════════════════════════════════

let records = [
  {id:'MDS-2024-001',title:'2024 Council Meeting Minutes - January',class:'Administrative',sub:'Council Records',sec:'Public',dept:'Administration',status:'Active',created:'2024-01-15',retYears:10,desc:'Official minutes of the January 2024 regular Council meeting.',fmt:'Digital - PDF',vital:'Yes'},
  {id:'MDS-2024-002',title:'Annual Financial Statements 2023',class:'Financial',sub:'Annual Reporting',sec:'Public',dept:'Finance',status:'Archived',created:'2024-03-01',retYears:7,desc:'Audited financial statements for fiscal year 2023.',fmt:'Digital - PDF',vital:'Yes'},
  {id:'MDS-2024-003',title:'Employee Benefits Policy v3.2',class:'Personnel',sub:'HR Policies',sec:'Confidential',dept:'Administration',status:'Active',created:'2024-02-10',retYears:7,desc:'Updated employee benefits and compensation policy.',fmt:'Digital - Word',vital:'No'},
  {id:'MDS-2024-004',title:'Road Maintenance Contract - Spring 2024',class:'Infrastructure',sub:'Contracts',sec:'Restricted',dept:'Infrastructure',status:'Under Review',created:'2024-04-05',retYears:7,desc:'Contract with municipal road services provider for spring maintenance.',fmt:'Digital - PDF',vital:'No'},
  {id:'MDS-2024-005',title:'Land Use Bylaw Amendment 2024-03',class:'Legal',sub:'Bylaws',sec:'Public',dept:'Planning & Development',status:'Active',created:'2024-05-20',retYears:0,desc:'Amendment to Land Use Bylaw regarding agricultural zoning.',fmt:'Digital - PDF',vital:'Yes'},
  {id:'MDS-2024-006',title:'Access to Information Request - File 24-019',class:'Legal',sub:'FOIP Requests',sec:'Highly Confidential',dept:'Corporate Services',status:'Active',created:'2024-06-01',retYears:3,desc:'ATI request from media outlet re: infrastructure spending.',fmt:'Digital - Email',vital:'No'},
  {id:'MDS-2024-007',title:'2024-2026 Capital Budget Plan',class:'Financial',sub:'Budget Planning',sec:'Confidential',dept:'Finance',status:'Under Review',created:'2024-07-15',retYears:7,desc:'Three-year capital expenditure plan for infrastructure and services.',fmt:'Digital - Excel',vital:'Yes'},
  {id:'MDS-2024-008',title:'Subdivision Application - Block 14 Lot 22',class:'Planning',sub:'Development Applications',sec:'Public',dept:'Planning & Development',status:'Active',created:'2024-08-03',retYears:10,desc:'Residential subdivision application for 14 new lots.',fmt:'Mixed',vital:'No'},
  {id:'MDS-2024-009',title:'Health & Safety Incident Report Q2',class:'Administrative',sub:'Safety Records',sec:'Restricted',dept:'Public Works',status:'Active',created:'2024-09-10',retYears:10,desc:'Quarterly workplace incident and near-miss summary report.',fmt:'Digital - PDF',vital:'No'},
  {id:'MDS-2024-010',title:'Water Treatment Plant Inspection 2024',class:'Infrastructure',sub:'Inspection Reports',sec:'Restricted',dept:'Infrastructure',status:'Pending Disposition',created:'2022-11-01',retYears:5,desc:'Annual inspection of municipal water treatment facility.',fmt:'Digital - PDF',vital:'No'},
];

let retentionRules = [
  {id:'RR-001',name:'Council Meeting Minutes',class:'Administrative',active:2,semi:8,disp:'P',leg:'MGA s.207, AR 225/2001',notes:'Official record of Council decisions. Permanent retention.'},
  {id:'RR-002',name:'Annual Financial Statements',class:'Financial',active:3,semi:4,disp:'A',leg:'MGA s.276',notes:'Transfer to Provincial Archives after 7 years.'},
  {id:'RR-003',name:'General Financial Records',class:'Financial',active:2,semi:5,disp:'D',leg:'MGA s.276, Income Tax Act',notes:'Includes invoices, receipts, AP/AR records.'},
  {id:'RR-004',name:'Bylaws & Resolutions',class:'Legal',active:5,semi:0,disp:'P',leg:'MGA s.207(1)',notes:'Permanent retention. Official legislative acts of Council.'},
  {id:'RR-005',name:'FOIP Requests & Responses',class:'Legal',active:2,semi:1,disp:'D',leg:'FOIP s.38, AR 186/2008',notes:'3-year total. Destroy after review period.'},
  {id:'RR-006',name:'Employee Personnel Files',class:'Personnel',active:7,semi:0,disp:'D',leg:'PIPA, Employment Standards Code',notes:'Retain 7 years after separation. Contains personal information — FOIP Part 2 applies.'},
  {id:'RR-007',name:'Capital Project Records',class:'Infrastructure',active:10,semi:0,disp:'A',leg:'MGA s.207, Municipal Engineering',notes:'Transfer to Archives. Infrastructure records with long-term liability.'},
  {id:'RR-008',name:'Development Applications',class:'Planning',active:5,semi:5,disp:'A',leg:'Land Titles Act, MGA',notes:'Transfer to Archives. Permanent land use record.'},
];

let auditLog = [
  {ts:'2024-09-15 14:32',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-009',note:'Created new Health & Safety Incident Report Q2'},
  {ts:'2024-09-10 09:15',user:'Ravi Patel',action:'CLASSIFY',target:'MDS-2024-008',note:'Reclassified from General to Planning > Development Applications'},
  {ts:'2024-08-20 11:02',user:'System',action:'DISPOSE',target:'MDS-2022-047',note:'Auto-flagged for disposition — retention period expired'},
  {ts:'2024-08-15 16:45',user:'Ravi Patel',action:'VIEW',target:'MDS-2024-006',note:'Accessed FOIP request file for response preparation'},
  {ts:'2024-08-03 10:30',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-008',note:'Created Subdivision Application record'},
  {ts:'2024-07-22 13:10',user:'Director Corporate Services',action:'EDIT',target:'RR-006',note:'Updated Personnel Files retention from 6 to 7 years per legal review'},
  {ts:'2024-07-15 09:00',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-007',note:'Created 2024-2026 Capital Budget Plan'},
  {ts:'2024-06-30 15:30',user:'System',action:'DISPOSE',target:'MDS-2021-031',note:'Certificate of Destruction issued — Financial record past retention'},
  {ts:'2024-06-01 08:45',user:'Ravi Patel',action:'CREATE',target:'MDS-2024-006',note:'Created FOIP Request file — marked Highly Confidential'},
  {ts:'2024-05-20 14:00',user:'Ravi Patel',action:'CLASSIFY',target:'MDS-2024-005',note:'Classified as Legal > Bylaws — Permanent retention applied'},
];

let classTree = [
  {code:'ADM',name:'Administrative',color:'g',items:[
    {code:'ADM-010',name:'Policy & Procedure Records',count:12,sec:'Internal'},
    {code:'ADM-020',name:'Council & Committee Records',count:48,sec:'Public'},
    {code:'ADM-030',name:'Correspondence & Communications',count:230,sec:'Mixed'},
    {code:'ADM-040',name:'Safety & Risk Management',count:34,sec:'Restricted'},
  ]},
  {code:'FIN',name:'Financial',color:'b',items:[
    {code:'FIN-010',name:'Budget & Financial Plans',count:22,sec:'Confidential'},
    {code:'FIN-020',name:'Annual Financial Statements',count:15,sec:'Public'},
    {code:'FIN-030',name:'Accounts Payable & Receivable',count:1840,sec:'Confidential'},
    {code:'FIN-040',name:'Grant Administration',count:28,sec:'Confidential'},
  ]},
  {code:'LEG',name:'Legal',color:'r',items:[
    {code:'LEG-010',name:'Bylaws & Resolutions',count:310,sec:'Public'},
    {code:'LEG-020',name:'Contracts & Agreements',count:94,sec:'Restricted'},
    {code:'LEG-030',name:'FOIP Requests',count:47,sec:'Highly Confidential'},
    {code:'LEG-040',name:'Litigation Records',count:8,sec:'Highly Confidential'},
  ]},
  {code:'INF',name:'Infrastructure',items:[
    {code:'INF-010',name:'Capital Projects',count:56,sec:'Restricted'},
    {code:'INF-020',name:'Inspection Reports',count:145,sec:'Restricted'},
    {code:'INF-030',name:'Asset Management',count:78,sec:'Internal'},
  ]},
  {code:'PER',name:'Personnel',color:'r',items:[
    {code:'PER-010',name:'Employee Files',count:43,sec:'Highly Confidential'},
    {code:'PER-020',name:'Recruitment Records',count:88,sec:'Confidential'},
    {code:'PER-030',name:'Training & Development',count:34,sec:'Confidential'},
  ]},
  {code:'PLN',name:'Planning',color:'g',items:[
    {code:'PLN-010',name:'Development Applications',count:203,sec:'Public'},
    {code:'PLN-020',name:'Land Use Bylaws',count:12,sec:'Public'},
    {code:'PLN-030',name:'Environmental Studies',count:29,sec:'Restricted'},
  ]},
];

let wzStep = 0;

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
function launchApp(){
  document.getElementById('splash').classList.add('out');
  setTimeout(()=>{
    document.getElementById('app').classList.add('show');
    initDashboard();
    renderRecords();
    renderRetention();
    renderClassTree();
    renderAudit();
    renderPolIndex();
  },700);
}

function showTab(id,btn){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  btn.classList.add('on');
}

// ═══════════════════════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════════════════════
function initDashboard(){
  const d = new Date();
  document.getElementById('dash-date').textContent = d.toLocaleDateString('en-CA',{year:'numeric',month:'long',day:'numeric'});

  const stats = [
    {n:records.length,l:'Total Records',cls:''},
    {n:records.filter(r=>r.status==='Active').length,l:'Active Records',cls:'g'},
    {n:records.filter(r=>r.status==='Pending Disposition').length,l:'Pending Disposition',cls:'r'},
    {n:records.filter(r=>r.vital==='Yes').length,l:'Vital Records',cls:'b'},
    {n:retentionRules.length,l:'Retention Rules',cls:''},
    {n:auditLog.length,l:'Audit Entries',cls:'g'},
  ];
  document.getElementById('dashStats').innerHTML = stats.map(s=>
    `<div class="sc ${s.cls}"><div class="sc-n">${s.n}</div><div class="sc-l">${s.l}</div></div>`
  ).join('');

  // Status chart
  const statuses = ['Active','Under Review','Pending Disposition','Archived'];
  const statusColors = {'Active':'var(--sage)','Under Review':'var(--gold)','Pending Disposition':'var(--rust)','Archived':'var(--slate)'};
  let sch = '';
  statuses.forEach(st=>{
    const cnt = records.filter(r=>r.status===st).length;
    const pct = Math.round(cnt/records.length*100);
    sch += `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;font-size:.68rem;margin-bottom:3px">
        <span>${st}</span><span style="color:var(--muted)">${cnt} (${pct}%)</span>
      </div>
      <div class="prog-wrap"><div class="prog-bar" style="width:${pct}%;background:${statusColors[st]}"></div></div>
    </div>`;
  });
  document.getElementById('statusChart').innerHTML = sch;

  // Disposition chart
  const classes = ['Administrative','Financial','Legal','Infrastructure','Personnel','Planning'];
  let dch = '';
  classes.forEach(c=>{
    const cnt = records.filter(r=>r.class===c&&r.status==='Pending Disposition').length+Math.floor(Math.random()*3);
    dch += `<div style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;font-size:.65rem;margin-bottom:3px">
        <span>${c}</span><span style="color:var(--muted)">${cnt}</span>
      </div>
      <div class="prog-wrap"><div class="prog-bar ${cnt>3?'r':''}" style="width:${Math.min(cnt*20,100)}%"></div></div>
    </div>`;
  });
  document.getElementById('dispChart').innerHTML = dch;

  // Recent activity
  document.getElementById('recentActivity').innerHTML = auditLog.slice(0,5).map(e=>logEntry(e)).join('');
}

// ═══════════════════════════════════════════════════════════
// RECORDS
// ═══════════════════════════════════════════════════════════
function renderRecords(){
  const q = (document.getElementById('recSearch').value||'').toLowerCase();
  const sf = document.getElementById('recStatusF').value;
  const cf = document.getElementById('recClassF').value;

  let filtered = records.filter(r=>{
    const matchQ = !q || r.id.toLowerCase().includes(q)||r.title.toLowerCase().includes(q)||(r.sub||'').toLowerCase().includes(q);
    const matchS = !sf || r.status===sf;
    const matchC = !cf || r.class===cf;
    return matchQ&&matchS&&matchC;
  });

  const retDate = r=>{
    if(r.retYears===0) return '<span style="color:var(--sage);font-size:.65rem">Permanent</span>';
    const d = new Date(r.created); d.setFullYear(d.getFullYear()+r.retYears);
    const diff = (d-new Date())/(1000*60*60*24*365);
    const color = diff<0.5?'var(--rust)':diff<1?'var(--gold)':'var(--muted)';
    return `<span style="color:${color};font-size:.68rem">${d.toISOString().split('T')[0]}</span>`;
  };

  document.getElementById('recTbody').innerHTML = filtered.map(r=>`
    <tr>
      <td style="font-size:.65rem;color:var(--muted)">${r.id}</td>
      <td><strong style="font-size:.74rem">${r.title}</strong>${r.vital==='Yes'?'<span style="color:var(--rust);margin-left:6px;font-size:.6rem">★ VITAL</span>':''}</td>
      <td><span style="font-size:.68rem">${r.class}</span><br><span style="color:var(--muted);font-size:.62rem">${r.sub||''}</span></td>
      <td>${secBadge(r.sec)}</td>
      <td>${statusBadge(r.status)}</td>
      <td style="font-size:.68rem;color:var(--muted)">${r.created}</td>
      <td>${retDate(r)}</td>
      <td>
        <button class="act-link" onclick="viewRecord('${r.id}')">View</button>
        <button class="act-link" onclick="disposeRecord('${r.id}')">Dispose</button>
      </td>
    </tr>
  `).join('');
  document.getElementById('recCount').textContent = `Showing ${filtered.length} of ${records.length} records`;
}

function secBadge(s){
  const m={'Public':'pub','Confidential':'con','Restricted':'res','Highly Confidential':'hi'};
  return `<span class="bdg bdg-${m[s]||'pub'}">${s}</span>`;
}
function statusBadge(s){
  const m={'Active':'act','Under Review':'rev','Pending Disposition':'dis','Archived':'arc'};
  return `<span class="bdg bdg-${m[s]||'act'}">${s}</span>`;
}

function viewRecord(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('vr-title').textContent = r.title;
  document.getElementById('vr-body').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
      ${dRow('Record ID',r.id)}${dRow('Classification',r.class+' > '+(r.sub||'–'))}
      ${dRow('Security',r.sec)}${dRow('Status',r.status)}
      ${dRow('Department',r.dept)}${dRow('Format',r.fmt)}
      ${dRow('Created',r.created)}${dRow('Retention',r.retYears===0?'Permanent':r.retYears+' years')}
      ${dRow('Vital Record',r.vital)}${dRow('Disposition Action',r.retYears===0?'Permanent (P)':'Destroy (D)')}
    </div>
    <div style="font-size:.62rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Description</div>
    <div style="font-size:.74rem;line-height:1.6;padding:12px;background:var(--cream);border:1px solid var(--rule)">${r.desc}</div>
  `;
  document.getElementById('vr-dispose-btn').onclick = ()=>{ closeModal('viewRecModal'); disposeRecord(id); };
  addAuditEntry('VIEW',id,`Viewed record: ${r.title}`);
  openModal('viewRecModal');
}

function dRow(k,v){
  return `<div><div style="font-size:.58rem;letter-spacing:.09em;text-transform:uppercase;color:var(--muted);margin-bottom:3px">${k}</div><div style="font-size:.74rem">${v}</div></div>`;
}

function addRecord(){
  const title = document.getElementById('nr-title').value.trim();
  if(!title){ notify('Please enter a record title.','err'); return; }
  const yr = parseInt(document.getElementById('nr-ret').value);
  const id = 'MDS-'+new Date().getFullYear()+'-'+String(records.length+1).padStart(3,'0');
  const r = {
    id, title,
    class: document.getElementById('nr-class').value,
    sub: document.getElementById('nr-subclass').value,
    sec: document.getElementById('nr-sec').value,
    dept: document.getElementById('nr-dept').value,
    status: 'Active',
    created: new Date().toISOString().split('T')[0],
    retYears: yr,
    desc: document.getElementById('nr-desc').value||'No description provided.',
    fmt: document.getElementById('nr-fmt').value,
    vital: document.getElementById('nr-vital').value==='Yes'?'Yes':'No',
  };
  records.unshift(r);
  addAuditEntry('CREATE',id,`Created new record: ${title}`);
  closeModal('addRecModal');
  document.getElementById('nr-title').value='';
  renderRecords();
  initDashboard();
  notify(`Record ${id} created successfully.`,'ok');
}

function disposeRecord(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  if(r.status==='Pending Disposition'||r.status==='Archived'){
    notify('Record is already in disposition or archived.','info'); return;
  }
  r.status = 'Pending Disposition';
  addAuditEntry('DISPOSE',id,`Disposition requested for: ${r.title}`);
  renderRecords();
  initDashboard();
  notify(`Record ${id} flagged for disposition review.`,'ok');
}

// ═══════════════════════════════════════════════════════════
// RETENTION
// ═══════════════════════════════════════════════════════════
function renderRetention(){
  const dispLabel = {'D':'Destroy','A':'Transfer to Archives','P':'Permanent Retention'};
  const dispColor = {'D':'r','A':'b','P':'g'};
  document.getElementById('retGrid').innerHTML = retentionRules.map(r=>`
    <div class="ret-card ${dispColor[r.disp]||''}">
      <div class="ret-cat">${r.class} · ${r.id}</div>
      <div class="ret-name">${r.name}</div>
      <div class="ret-row"><span class="ret-key">Active Period</span><span class="ret-val">${r.active} year${r.active!==1?'s':''}</span></div>
      <div class="ret-row"><span class="ret-key">Semi-Active</span><span class="ret-val">${r.semi>0?r.semi+' year'+(r.semi!==1?'s':''):'—'}</span></div>
      <div class="ret-row"><span class="ret-key">Total Retention</span><span class="ret-val">${r.disp==='P'?'Permanent':(r.active+r.semi)+' years'}</span></div>
      <div class="ret-row"><span class="ret-key">Final Disposition</span><span class="ret-val" style="color:${r.disp==='D'?'var(--rust)':r.disp==='P'?'var(--sage)':'var(--slate)'}">${dispLabel[r.disp]}</span></div>
      <div class="ret-row"><span class="ret-key">Authority</span><span class="ret-val" style="font-size:.62rem">${r.leg}</span></div>
      ${r.notes?`<div style="font-size:.64rem;color:var(--muted);margin-top:8px;line-height:1.5">${r.notes}</div>`:''}
    </div>
  `).join('');
}

function addRetention(){
  const name = document.getElementById('ret-name').value.trim();
  if(!name){ notify('Please enter a record series name.','err'); return; }
  retentionRules.push({
    id:'RR-'+String(retentionRules.length+1).padStart(3,'0'),
    name,
    class: document.getElementById('ret-class').value,
    active: parseInt(document.getElementById('ret-active').value)||2,
    semi: parseInt(document.getElementById('ret-semi').value)||0,
    disp: document.getElementById('ret-disp').value,
    leg: document.getElementById('ret-leg').value||'TBD',
    notes: document.getElementById('ret-notes').value,
  });
  addAuditEntry('CREATE','RR-NEW',`Added retention rule: ${name}`);
  closeModal('addRetModal');
  document.getElementById('ret-name').value='';
  renderRetention();
  notify('Retention rule added to schedule.','ok');
}

function exportRetention(){
  let csv = 'ID,Record Series,Classification,Active (yrs),Semi-Active (yrs),Disposition,Authority\n';
  retentionRules.forEach(r=>{
    csv += `"${r.id}","${r.name}","${r.class}",${r.active},${r.semi},"${r.disp}","${r.leg}"\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='MDS_Retention_Schedule.csv'; a.click();
  notify('Retention schedule exported as CSV.','ok');
}

// ═══════════════════════════════════════════════════════════
// CLASSIFICATION TREE
// ═══════════════════════════════════════════════════════════
function renderClassTree(){
  document.getElementById('classTree').innerHTML = classTree.map(c=>`
    <div class="tree-node">
      <div class="tree-parent" onclick="toggleTree('${c.code}'); showClassDetail(${JSON.stringify(c).replace(/"/g,'&quot;')})">
        <span style="color:var(--muted);font-size:.8rem">▸</span>
        <strong>${c.code}</strong> — ${c.name}
        <span style="margin-left:auto;font-size:.6rem;color:var(--muted)">${c.items.length} series</span>
      </div>
      <div class="tree-children" id="tree-${c.code}">
        ${c.items.map(i=>`
          <div class="tree-child" onclick="showSubDetail(${JSON.stringify(i).replace(/"/g,'&quot;')})">
            <span style="color:var(--muted);font-size:.68rem">${i.code} — ${i.name}</span>
            <span class="bdg" style="background:var(--cream);color:var(--muted)">${i.count}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

function toggleTree(code){
  const el = document.getElementById('tree-'+code);
  el.classList.toggle('open');
}

function showClassDetail(c){
  document.getElementById('classDetail').innerHTML = `
    <div style="font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:4px">${c.code}</div>
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;margin-bottom:14px">${c.name} Records</div>
    <div style="font-size:.68rem;color:var(--muted);margin-bottom:14px">${c.items.length} record series · ${c.items.reduce((a,i)=>a+i.count,0)} total records</div>
    ${c.items.map(i=>`
      <div style="padding:10px;border:1px solid var(--rule);margin-bottom:8px;background:var(--cream);cursor:pointer" onclick="showSubDetail(${JSON.stringify(i).replace(/"/g,"'")})">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <strong style="font-size:.72rem">${i.code}</strong>
          <span class="bdg bdg-${i.sec==='Public'?'pub':i.sec==='Confidential'?'con':i.sec==='Restricted'?'res':'hi'}">${i.sec}</span>
        </div>
        <div style="font-size:.7rem">${i.name}</div>
        <div style="font-size:.6rem;color:var(--muted);margin-top:4px">${i.count} records</div>
      </div>
    `).join('')}
  `;
}

function showSubDetail(i){
  document.getElementById('classDetail').innerHTML = `
    <div style="font-size:.58rem;color:var(--muted);margin-bottom:4px;letter-spacing:.08em;text-transform:uppercase">Record Series Detail</div>
    <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;margin-bottom:12px">${i.name}</div>
    ${dRow('Classification Code',i.code)}
    <div style="height:10px"></div>
    ${dRow('Security Level',i.sec)}
    <div style="height:10px"></div>
    ${dRow('Total Records',i.count+' records')}
    <div style="height:16px"></div>
    <button class="btn btn-g" style="font-size:.65rem" onclick="document.getElementById('recClassF').value='${i.code.split('-')[0]==='ADM'?'Administrative':i.code.split('-')[0]==='FIN'?'Financial':i.code.split('-')[0]==='LEG'?'Legal':i.code.split('-')[0]==='INF'?'Infrastructure':i.code.split('-')[0]==='PER'?'Personnel':'Planning'}';showTab('records',document.querySelector('.nav-tab:nth-child(2)'))">View Records in This Series →</button>
  `;
}

// ═══════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════
function logEntry(e){
  const icons={'CREATE':'✚','EDIT':'✎','VIEW':'◉','DISPOSE':'⊗','CLASSIFY':'⊞'};
  const cls={'CREATE':'li-add','EDIT':'li-edit','VIEW':'li-view','DISPOSE':'li-dis','CLASSIFY':'li-edit'};
  return `<div class="log-entry">
    <div class="log-ts">${e.ts}</div>
    <div class="log-icon ${cls[e.action]||'li-view'}">${icons[e.action]||'•'}</div>
    <div class="log-text"><span class="log-user">${e.user}</span> · <span style="color:var(--gold)">${e.action}</span> · <span style="color:var(--muted);font-size:.65rem">${e.target}</span><br>${e.note}</div>
  </div>`;
}

function renderAudit(){
  const f = document.getElementById('auditFilter').value;
  const filtered = f ? auditLog.filter(e=>e.action===f) : auditLog;
  document.getElementById('auditLog').innerHTML = filtered.map(e=>logEntry(e)).join('');
}

function addAuditEntry(action,target,note){
  const now = new Date();
  const ts = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  auditLog.unshift({ts,user:'Ravi Patel',action,target,note});
  if(document.getElementById('sec-audit').classList.contains('on')) renderAudit();
}

function exportAudit(){
  let csv='Timestamp,User,Action,Record ID,Notes\n';
  auditLog.forEach(e=>{ csv+=`"${e.ts}","${e.user}","${e.action}","${e.target}","${e.note}"\n`; });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='MDS_Audit_Log.csv'; a.click();
  notify('Audit log exported as CSV.','ok');
}

// ═══════════════════════════════════════════════════════════
// POLICY WIZARD
// ═══════════════════════════════════════════════════════════
function wzNext(){
  if(wzStep<3){
    document.getElementById('wp'+wzStep).classList.remove('on');
    document.getElementById('ws'+wzStep).classList.remove('active');
    document.getElementById('ws'+wzStep).classList.add('done');
    wzStep++;
    document.getElementById('wp'+wzStep).classList.add('on');
    document.getElementById('ws'+wzStep).classList.add('active');
  }
}
function wzPrev(){
  if(wzStep>0){
    document.getElementById('wp'+wzStep).classList.remove('on');
    document.getElementById('ws'+wzStep).classList.remove('active');
    wzStep--;
    document.getElementById('ws'+wzStep).classList.remove('done');
    document.getElementById('wp'+wzStep).classList.add('on');
    document.getElementById('ws'+wzStep).classList.add('active');
  }
}
function publishPolicy(){
  for(let i=0;i<4;i++){
    document.getElementById('ws'+i).classList.remove('active');
    document.getElementById('ws'+i).classList.add('done');
  }
  notify('Records Management Policy marked complete and published to EDRMS.','ok');
  addAuditEntry('CREATE','POL-001','Records Management Policy v1.0 published');
}

function renderPolIndex(){
  const policies=[
    {name:'Records Management Policy v1.0',status:'Draft',date:'2024-09-15'},
    {name:'Retention & Disposition Procedure',status:'Approved',date:'2024-01-10'},
    {name:'FOIP Request Handling Procedure',status:'Approved',date:'2023-11-01'},
    {name:'Vital Records Register',status:'Under Review',date:'2024-08-20'},
    {name:'Classification Scheme Guidelines',status:'Approved',date:'2023-06-15'},
  ];
  document.getElementById('polIndex').innerHTML = policies.map(p=>`
    <div style="padding:8px 0;border-bottom:1px solid var(--cream);">
      <div style="font-size:.7rem;font-weight:500">${p.name}</div>
      <div style="display:flex;justify-content:space-between;margin-top:3px">
        <span style="font-size:.6rem;color:${p.status==='Approved'?'var(--sage)':p.status==='Draft'?'var(--gold)':'var(--slate)'}">${p.status}</span>
        <span style="font-size:.6rem;color:var(--muted)">${p.date}</span>
      </div>
    </div>
  `).join('');
}

// ═══════════════════════════════════════════════════════════
// MODALS & NOTIFICATIONS
// ═══════════════════════════════════════════════════════════
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.ov').forEach(ov=>{
  ov.addEventListener('click',e=>{ if(e.target===ov) ov.classList.remove('open'); });
});

function notify(msg,type='ok'){
  const el = document.getElementById('notif');
  const item = document.createElement('div');
  item.className = `notif-item ni-${type}`;
  item.textContent = msg;
  el.appendChild(item);
  setTimeout(()=>item.style.opacity='0',3000);
  setTimeout(()=>item.remove(),3400);
}

// ── set date ──
document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-CA',{year:'numeric',month:'long',day:'numeric'});
</script>
</body>
</html>
